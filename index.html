<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Peta Kabupaten & Desa (Revisi)</title>

  <!-- OpenLayers & CSS -->
  <link rel="stylesheet" href="./resources/ol.css" />
  <link rel="stylesheet" href="resources/fontawesome-all.min.css" />
  <link href="resources/photon-geocoder-autocomplete.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="./resources/ol-layerswitcher.css" />
  <link rel="stylesheet" href="./resources/qgis2web.css" />

  <style>
    html, body, #map {
      margin: 0; padding: 0; width: 100%; height: 100%;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    }
    .ol-control > * {
      background-color: #f8f8f8 !important;
      color: #444 !important;
      border-radius: 0;
    }
    .ol-attribution a, .gcd-gl-input::placeholder, .search-layer-input-search::placeholder {
      color: #444 !important;
    }
    .search-layer-input-search {
      background-color: #f8f8f8 !important;
    }
    .ol-control > *:focus, .ol-control > *:hover {
      background-color: rgba(248, 248, 248, 0.7) !important;
    }
    .ol-control {
      background-color: rgba(255,255,255,0.4) !important;
      padding: 2px !important;
    }
    /* Top bar */
    #topbar {
      position: absolute;
      left: 10px;
      top: 10px;
      z-index: 1100;
      background: rgba(255,255,255,0.95);
      padding: 8px 10px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      max-width: 100vw;
    }
    label {
      font-size: 13px;
      font-weight: 600;
    }
    select, input, button {
      padding: 6px 10px;
      font-size: 13px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: inherit;
      outline: none;
    }
    select:hover, input:hover, button:hover {
      border-color: #888;
    }
    button {
      cursor: pointer;
      background-color: #eee;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #ddd;
    }

    /* Popup */
    .ol-popup {
      position: absolute;
      background-color: white;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 10px;
      border: 1px solid #cccccc;
      bottom: 12px;
      left: -50px;
      min-width: 200px;
      font-size: 13px;
    }
    .ol-popup:after, .ol-popup:before {
      top: 100%;
      border: solid transparent;
      content: " ";
      height: 0;
      width: 0;
      position: absolute;
      pointer-events: none;
    }
    .ol-popup:after {
      border-top-color: white;
      border-width: 10px;
      left: 48px;
      margin-left: -10px;
    }
    .ol-popup:before {
      border-top-color: #cccccc;
      border-width: 11px;
      left: 48px;
      margin-left: -11px;
    }
    .ol-popup-closer {
      text-decoration: none;
      position: absolute;
      top: 2px;
      right: 8px;
      font-weight: bold;
      font-size: 18px;
      color: #aaa;
    }
    .ol-popup-closer:hover {
      color: #000;
    }
  </style>
</head>
<body>

  <!-- Top controls -->
  <div id="topbar">
    <label for="kabupatenSelect">Pilih Kabupaten/Kota:</label>
    <select id="kabupatenSelect"><option value="">-- Memuat... --</option></select>

    <label for="searchDesa">Cari Desa:</label>
    <input id="searchDesa" placeholder="ketik nama desa lalu Enter" />

    <button id="btnReset">Reset</button>
  </div>

  <!-- Map container -->
  <div id="map">
    <div id="popup" class="ol-popup" style="display:none;">
      <a href="#" id="popup-closer" class="ol-popup-closer">&#215;</a>
      <div id="popup-content"></div>
    </div>
  </div>

  <!-- QGIS2Web & OpenLayers scripts -->
  <script src="resources/qgis2web_expressions.js"></script>
  <script src="./resources/functions.js"></script>
  <script src="./resources/ol.js"></script>
  <script src="./resources/ol-layerswitcher.js"></script>
  <script src="resources/photon-geocoder-autocomplete.min.js"></script>

  <!-- Load layers scripts -->
  <script src="layers/Pacitan_1.js"></script>
  <script src="layers/Ponorogo_2.js"></script>
  <script src="layers/Trenggalek_3.js"></script>
  <script src="layers/Tulungagung_4.js"></script>
  <script src="layers/Blitar_5.js"></script>
  <script src="layers/KotaBlitar_6.js"></script>
  <script src="layers/Kediri_7.js"></script>
  <script src="layers/KotaKediri_8.js"></script>
  <script src="layers/Malang_9.js"></script>
  <script src="layers/KotaMalang_10.js"></script>
  <script src="layers/Lumajang_11.js"></script>
  <script src="layers/Jember_12.js"></script>
  <script src="layers/Banyuwangi_13.js"></script>
  <script src="layers/Bondowoso_14.js"></script>
  <script src="layers/Situbondo_15.js"></script>
  <script src="layers/Probolinggo_16.js"></script>
  <script src="layers/KotaProbolinggo_17.js"></script>
  <script src="layers/Pasuruan_18.js"></script>
  <script src="layers/KotaPasuruan_19.js"></script>
  <script src="layers/Sidoarjo_20.js"></script>
  <script src="layers/Mojokerto_21.js"></script>
  <script src="layers/KotaMojokerto_22.js"></script>
  <script src="layers/Jombang_23.js"></script>
  <script src="layers/Ngajuk_24.js"></script>
  <script src="layers/Madiun_25.js"></script>
  <script src="layers/KotaMadiun_26.js"></script>
  <script src="layers/Magetan_27.js"></script>
  <script src="layers/Ngawi_28.js"></script>
  <script src="layers/Bojonegoro_29.js"></script>
  <script src="layers/Tuban_30.js"></script>
  <script src="layers/Lamongan_31.js"></script>
  <script src="layers/Gresik_32.js"></script>
  <script src="layers/Bangkalan_33.js"></script>
  <script src="layers/Sampang_34.js"></script>
  <script src="layers/Pamekasan_35.js"></script>
  <script src="layers/Sumenep_36.js"></script>
  <script src="layers/Surabaya_37.js"></script>
  <script src="layers/Batu_38.js"></script>
  <script src="layers/BatasKabupaten_39.js"></script>

  <!-- Load styles scripts -->
  <script src="styles/Pacitan_1_style.js"></script>
  <script src="styles/Ponorogo_2_style.js"></script>
  <script src="styles/Trenggalek_3_style.js"></script>
  <script src="styles/Tulungagung_4_style.js"></script>
  <script src="styles/Blitar_5_style.js"></script>
  <script src="styles/KotaBlitar_6_style.js"></script>
  <script src="styles/Kediri_7_style.js"></script>
  <script src="styles/KotaKediri_8_style.js"></script>
  <script src="styles/Malang_9_style.js"></script>
  <script src="styles/KotaMalang_10_style.js"></script>
  <script src="styles/Lumajang_11_style.js"></script>
  <script src="styles/Jember_12_style.js"></script>
  <script src="styles/Banyuwangi_13_style.js"></script>
  <script src="styles/Bondowoso_14_style.js"></script>
  <script src="styles/Situbondo_15_style.js"></script>
  <script src="styles/Probolinggo_16_style.js"></script>
  <script src="styles/KotaProbolinggo_17_style.js"></script>
  <script src="styles/Pasuruan_18_style.js"></script>
  <script src="styles/KotaPasuruan_19_style.js"></script>
  <script src="styles/Sidoarjo_20_style.js"></script>
  <script src="styles/Mojokerto_21_style.js"></script>
  <script src="styles/KotaMojokerto_22_style.js"></script>
  <script src="styles/Jombang_23_style.js"></script>
  <script src="styles/Ngajuk_24_style.js"></script>
  <script src="styles/Madiun_25_style.js"></script>
  <script src="styles/KotaMadiun_26_style.js"></script>
  <script src="styles/Magetan_27_style.js"></script>
  <script src="styles/Ngawi_28_style.js"></script>
  <script src="styles/Bojonegoro_29_style.js"></script>
  <script src="styles/Tuban_30_style.js"></script>
  <script src="styles/Lamongan_31_style.js"></script>
  <script src="styles/Gresik_32_style.js"></script>
  <script src="styles/Bangkalan_33_style.js"></script>
  <script src="styles/Sampang_34_style.js"></script>
  <script src="styles/Pamekasan_35_style.js"></script>
  <script src="styles/Sumenep_36_style.js"></script>
  <script src="styles/Surabaya_37_style.js"></script>
  <script src="styles/Batu_38_style.js"></script>
  <script src="styles/BatasKabupaten_39_style.js"></script>

  <!-- Layers list & Autolinker -->
  <script src="./layers/layers.js"></script>
  <script src="./resources/Autolinker.min.js"></script>

  <!-- qgis2web main script -->
  <script src="./resources/qgis2web.js"></script>

  <!-- Custom script -->
  <script>
    (function(){

      // Helper safe text
      function safeText(v){
        return (v === undefined || v === null || v === '') ? '-' : String(v);
      }

      // Wait for map and layer variables (usually created by qgis2web.js)
      function waitForCondition(conditionFn, interval=100, timeout=10000){
        return new Promise((resolve)=>{
          const start = Date.now();
          (function check(){
            if(conditionFn()) return resolve(true);
            if(Date.now() - start > timeout) return resolve(false);
            setTimeout(check, interval);
          })();
        });
      }

      waitForCondition(() => typeof map !== 'undefined' && typeof layersList !== 'undefined').then(ok => {
        if(!ok){
          alert('Map atau layersList belum tersedia.');
          return;
        }

        // ------------------------
        // --- DEFINISI LAYER KABUPATEN & KOTA ---
        // pastikan layer variabel sudah didefinisikan di file layers/*.js
        // contoh: var layer_Pacitan_1, layer_Ponorogo_2, ...
        const kabupatenLayers = [
          layer_Pacitan_1,
          layer_Ponorogo_2,
          layer_Trenggalek_3,
          layer_Tulungagung_4,
          layer_Blitar_5,
          layer_KotaBlitar_6,
          layer_Kediri_7,
          layer_KotaKediri_8,
          layer_Malang_9,
          layer_KotaMalang_10,
          layer_Lumajang_11,
          layer_Jember_12,
          layer_Banyuwangi_13,
          layer_Bondowoso_14,
          layer_Situbondo_15,
          layer_Probolinggo_16,
          layer_KotaProbolinggo_17,
          layer_Pasuruan_18,
          layer_KotaPasuruan_19,
          layer_Sidoarjo_20,
          layer_Mojokerto_21,
          layer_KotaMojokerto_22,
          layer_Jombang_23,
          layer_Ngajuk_24,
          layer_Madiun_25,
          layer_KotaMadiun_26,
          layer_Magetan_27,
          layer_Ngawi_28,
          layer_Bojonegoro_29,
          layer_Tuban_30,
          layer_Lamongan_31,
          layer_Gresik_32,
          layer_Bangkalan_33,
          layer_Sampang_34,
          layer_Pamekasan_35,
          layer_Sumenep_36,
          layer_Surabaya_37,
          layer_Batu_38
        ];

        // Layer batas kabupaten (outline) yang selalu tampil
        const batasKabupatenLayer = layer_BatasKabupaten_39;

        // ------------------------
        // Initialize: show all kabupaten with full opacity
        kabupatenLayers.forEach(lyr=>{
          lyr.setVisible(true);
          lyr.setOpacity(1);
        });
        // Batas kabupaten selalu tampil dengan opacity 1
        batasKabupatenLayer.setVisible(true);
        batasKabupatenLayer.setOpacity(1);

        // Initialize map view: zoom ke gabungan semua kabupaten
        try {
          // Gabung extent semua kabupaten
          let combinedExtent = ol.extent.createEmpty();
          kabupatenLayers.forEach(lyr=>{
            const ext = lyr.getSource().getExtent();
            if(ext && !ol.extent.isEmpty(ext)) ol.extent.extend(combinedExtent, ext);
          });
          map.getView().fit(combinedExtent, {padding:[40,40,40,40], maxZoom: 9, duration: 700});
        } catch(e){
          console.warn('Gagal set extent awal gabungan kabupaten', e);
        }

        // Fill dropdown kabupaten
        const kabSelect = document.getElementById('kabupatenSelect');
        kabSelect.innerHTML = '';
        kabupatenLayers.forEach((lyr, i)=>{
          let title = lyr.get('title') || lyr.get('name') || `Kabupaten ${i+1}`;
          let opt = document.createElement('option');
          opt.value = i;
          opt.textContent = title;
          kabSelect.appendChild(opt);
        });

        // Hover interaction - highlight style
        let hoverInteraction = null;
        function enableHoverOnLayer(layer){
          if(hoverInteraction) map.removeInteraction(hoverInteraction);
          if(!layer) return;
          hoverInteraction = new ol.interaction.Select({
            condition: ol.events.condition.pointerMove,
            layers: [layer],
            style: new ol.style.Style({
              stroke: new ol.style.Stroke({
                color: 'yellow',
                width: 3
              }),
              fill: new ol.style.Fill({
                color: 'rgba(255, 255, 0, 0.3)'
              })
            })
          });
          map.addInteraction(hoverInteraction);
        }

        // Set initial hover on all kabupaten layers combined by making a temporary group layer?
        // But simpler: for initial, enable hover on all kabupaten layers at once
        // Because ol.interaction.Select supports multiple layers
        enableHoverOnLayer(new ol.layer.Group({ layers: kabupatenLayers }));

        // Popup overlay
        const popupEl = document.getElementById('popup');
        const popupCloser = document.getElementById('popup-closer');
        const popupContent = document.getElementById('popup-content');
        const overlay = new ol.Overlay({
          element: popupEl,
          autoPan: {
            animation: {
              duration: 250
            }
          }
        });
        map.addOverlay(overlay);
        popupCloser.onclick = function(){
          overlay.setPosition(undefined);
          popupEl.style.display = 'none';
          popupCloser.blur();
          return false;
        };

        // Click on feature popup (only active layer(s))
        map.on('singleclick', function(evt){
          // Find feature on kabupaten layers (only visible ones)
          let features = [];
          kabupatenLayers.forEach(lyr=>{
            if(lyr.getVisible()){
              const feature = map.forEachFeatureAtPixel(evt.pixel, (f, l) => (l === lyr) ? f : null);
              if(feature) features.push(feature);
            }
          });
          // If found multiple features, pick first
          if(features.length > 0){
            const f = features[0];
            const props = f.getProperties();
            let html = `<strong>${safeText(props['NAME_2'] || props['name'] || props['nama'])}</strong><br/>`;
            if(props['ID_2']) html += `ID: ${props['ID_2']}<br/>`;
            overlay.setPosition(evt.coordinate);
            popupContent.innerHTML = html;
            popupEl.style.display = 'block';
          } else {
            overlay.setPosition(undefined);
            popupEl.style.display = 'none';
          }
        });

        // Dropdown change handler: focus on selected kabupaten
        kabSelect.addEventListener('change', function(){
          let idx = this.value;
          if(idx === ''){
            // Show all kabupaten full opacity again
            kabupatenLayers.forEach(lyr => {
              lyr.setOpacity(1);
              lyr.setVisible(true);
            });
            batasKabupatenLayer.setOpacity(1);
            map.getView().setZoom(7);
            map.getView().setCenter([11250000, -720000]);
            return;
          }
          idx = Number(idx);
          // Fokus layer terpilih: opacity 1, yang lain opacity 0.3
          kabupatenLayers.forEach((lyr,i)=>{
            lyr.setOpacity(i === idx ? 1 : 0.3);
            lyr.setVisible(true);
          });
          batasKabupatenLayer.setOpacity(1);
          // Zoom ke extent kabupaten yang dipilih
          const ext = kabupatenLayers[idx].getSource().getExtent();
          if(ext) map.getView().fit(ext, {padding:[50,50,50,50], maxZoom: 12, duration: 500});

          // Update hover interaction ke layer yg dipilih saja
          enableHoverOnLayer(kabupatenLayers[idx]);

          // Clear popup
          overlay.setPosition(undefined);
          popupEl.style.display = 'none';
        });

        // Search desa - simple text search on active layer features
        const searchInput = document.getElementById('searchDesa');
        searchInput.addEventListener('keydown', function(evt){
          if(evt.key !== 'Enter') return;
          const searchText = this.value.trim().toLowerCase();
          if(!searchText) return;

          // Cari di layer kabupaten yg aktif (visible dan opacity 1)
          const activeLayer = kabupatenLayers.find(lyr => lyr.getVisible() && lyr.getOpacity() === 1);
          if(!activeLayer){
            alert('Pilih kabupaten/kota dulu sebelum cari desa');
            return;
          }
          const source = activeLayer.getSource();
          const features = source.getFeatures();
          // Cari feature yang nama desanya mengandung kata kunci searchText
          let foundFeature = null;
          for(let f of features){
            let namaDesa = (f.get('NAME_3') || f.get('name') || f.get('nama') || '').toLowerCase();
            if(namaDesa.indexOf(searchText) !== -1){
              foundFeature = f;
              break;
            }
          }
          if(!foundFeature){
            alert('Desa tidak ditemukan di kabupaten/kota yang dipilih');
            return;
          }

          // Zoom ke feature dan buka popup
          const geom = foundFeature.getGeometry();
          const ext = geom.getExtent();
          if(ext){
            map.getView().fit(ext, {padding:[100,100,100,100], maxZoom: 15, duration: 700});
          }
          const props = foundFeature.getProperties();
          let html = `<strong>${safeText(props['NAME_3'] || props['name'] || props['nama'])}</strong><br/>`;
          overlay.setPosition(geom.getCoordinates());
          popupContent.innerHTML = html;
          popupEl.style.display = 'block';
        });

        // Reset button to show all kabupaten and zoom out
        document.getElementById('btnReset').addEventListener('click', () => {
          kabupatenLayers.forEach(lyr => {
            lyr.setVisible(true);
            lyr.setOpacity(1);
          });
          batasKabupatenLayer.setOpacity(1);
          map.getView().setZoom(7);
          map.getView().setCenter([11250000, -720000]);
          enableHoverOnLayer(new ol.layer.Group({ layers: kabupatenLayers }));
          overlay.setPosition(undefined);
          popupEl.style.display = 'none';
          kabSelect.value = '';
          searchInput.value = '';
        });

      }); // end waitForCondition

    })();
  </script>

</body>
</html>
