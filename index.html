<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Peta Kabupaten & Kota Jawa Timur</title>

  <!-- OpenLayers CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol/ol.css" />
  
  <style>
    html, body, #map {
      margin: 0; padding: 0; width: 100%; height: 100%;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    }
    
    /* Kontrol OpenLayers */
    .ol-control > * {
      background-color: #f8f8f8 !important;
      color: #444 !important;
      border-radius: 4px;
    }
    .ol-control {
      background-color: rgba(255,255,255,0.4) !important;
      padding: 5px !important;
    }
    
    /* Top bar */
    #topbar {
      position: absolute;
      left: 10px;
      top: 10px;
      z-index: 1100;
      background: rgba(255,255,255,0.95);
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
      max-width: calc(100vw - 40px);
    }
    
    label {
      font-size: 14px;
      font-weight: 600;
      white-space: nowrap;
      color: #333;
    }
    
    /* Dropdown styling */
    select {
      padding: 8px 12px;
      font-size: 14px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background-color: #fff;
      color: #333;
      min-width: 200px;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 10px center;
      background-size: 16px;
      padding-right: 35px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    select:hover {
      border-color: #bbb;
      box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.05);
    }
    
    select:focus {
      border-color: #4d90fe;
      box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.3);
      outline: none;
    }
    
    /* Button */
    button {
      padding: 8px 16px;
      font-size: 14px;
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      border-radius: 6px;
      color: #333;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    
    button:hover {
      background-color: #e0e0e0;
      border-color: #ccc;
    }
    
    button:active {
      background-color: #d0d0d0;
    }
    
    /* Popup */
    .ol-popup {
      position: absolute;
      background-color: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 10px;
      border: 1px solid #ddd;
      bottom: 12px;
      left: -50px;
      min-width: 220px;
      font-size: 14px;
    }
    
    .ol-popup:after, .ol-popup:before {
      top: 100%;
      border: solid transparent;
      content: " ";
      height: 0;
      width: 0;
      position: absolute;
      pointer-events: none;
    }
    
    .ol-popup:after {
      border-top-color: white;
      border-width: 10px;
      left: 48px;
      margin-left: -10px;
    }
    
    .ol-popup:before {
      border-top-color: #ddd;
      border-width: 11px;
      left: 48px;
      margin-left: -11px;
    }
    
    .ol-popup-closer {
      text-decoration: none;
      position: absolute;
      top: 5px;
      right: 8px;
      font-weight: bold;
      font-size: 18px;
      color: #999;
      cursor: pointer;
    }
    
    .ol-popup-closer:hover {
      color: #333;
    }
  </style>
</head>
<body>

  <!-- Top controls -->
  <div id="topbar">
    <label for="kabupatenSelect">Pilih Kabupaten/Kota:</label>
    <select id="kabupatenSelect">
      <option value="">-- Semua Kabupaten --</option>
    </select>

    <button id="btnReset">Reset Peta</button>
  </div>

  <!-- Map container -->
  <div id="map">
    <div id="popup" class="ol-popup" style="display:none;">
      <a href="#" id="popup-closer" class="ol-popup-closer">&times;</a>
      <div id="popup-content"></div>
    </div>
  </div>

  <!-- OpenLayers JS -->
  <script src="https://cdn.jsdelivr.net/npm/ol/ol.js"></script>

  <!-- Load layers scripts -->
  <script src="layers/Pacitan_1.js"></script>
  <script src="layers/Ponorogo_2.js"></script>
  <script src="layers/Trenggalek_3.js"></script>
  <script src="layers/Tulungagung_4.js"></script>
  <script src="layers/Blitar_5.js"></script>
  <script src="layers/KotaBlitar_6.js"></script>
  <script src="layers/Kediri_7.js"></script>
  <script src="layers/KotaKediri_8.js"></script>
  <script src="layers/Malang_9.js"></script>
  <script src="layers/KotaMalang_10.js"></script>
  <script src="layers/Lumajang_11.js"></script>
  <script src="layers/Jember_12.js"></script>
  <script src="layers/Banyuwangi_13.js"></script>
  <script src="layers/Bondowoso_14.js"></script>
  <script src="layers/Situbondo_15.js"></script>
  <script src="layers/Probolinggo_16.js"></script>
  <script src="layers/KotaProbolinggo_17.js"></script>
  <script src="layers/Pasuruan_18.js"></script>
  <script src="layers/KotaPasuruan_19.js"></script>
  <script src="layers/Sidoarjo_20.js"></script>
  <script src="layers/Mojokerto_21.js"></script>
  <script src="layers/KotaMojokerto_22.js"></script>
  <script src="layers/Jombang_23.js"></script>
  <script src="layers/Ngajuk_24.js"></script>
  <script src="layers/Madiun_25.js"></script>
  <script src="layers/KotaMadiun_26.js"></script>
  <script src="layers/Magetan_27.js"></script>
  <script src="layers/Ngawi_28.js"></script>
  <script src="layers/Bojonegoro_29.js"></script>
  <script src="layers/Tuban_30.js"></script>
  <script src="layers/Lamongan_31.js"></script>
  <script src="layers/Gresik_32.js"></script>
  <script src="layers/Bangkalan_33.js"></script>
  <script src="layers/Sampang_34.js"></script>
  <script src="layers/Pamekasan_35.js"></script>
  <script src="layers/Sumenep_36.js"></script>
  <script src="layers/Surabaya_37.js"></script>
  <script src="layers/Batu_38.js"></script>
  <script src="layers/BatasKabupaten_39.js"></script>

  <!-- Load styles scripts -->
  <script src="styles/Pacitan_1_style.js"></script>
  <script src="styles/Ponorogo_2_style.js"></script>
  <script src="styles/Trenggalek_3_style.js"></script>
  <script src="styles/Tulungagung_4_style.js"></script>
  <script src="styles/Blitar_5_style.js"></script>
  <script src="styles/KotaBlitar_6_style.js"></script>
  <script src="styles/Kediri_7_style.js"></script>
  <script src="styles/KotaKediri_8_style.js"></script>
  <script src="styles/Malang_9_style.js"></script>
  <script src="styles/KotaMalang_10_style.js"></script>
  <script src="styles/Lumajang_11_style.js"></script>
  <script src="styles/Jember_12_style.js"></script>
  <script src="styles/Banyuwangi_13_style.js"></script>
  <script src="styles/Bondowoso_14_style.js"></script>
  <script src="styles/Situbondo_15_style.js"></script>
  <script src="styles/Probolinggo_16_style.js"></script>
  <script src="styles/KotaProbolinggo_17_style.js"></script>
  <script src="styles/Pasuruan_18_style.js"></script>
  <script src="styles/KotaPasuruan_19_style.js"></script>
  <script src="styles/Sidoarjo_20_style.js"></script>
  <script src="styles/Mojokerto_21_style.js"></script>
  <script src="styles/KotaMojokerto_22_style.js"></script>
  <script src="styles/Jombang_23_style.js"></script>
  <script src="styles/Ngajuk_24_style.js"></script>
  <script src="styles/Madiun_25_style.js"></script>
  <script src="styles/KotaMadiun_26_style.js"></script>
  <script src="styles/Magetan_27_style.js"></script>
  <script src="styles/Ngawi_28_style.js"></script>
  <script src="styles/Bojonegoro_29_style.js"></script>
  <script src="styles/Tuban_30_style.js"></script>
  <script src="styles/Lamongan_31_style.js"></script>
  <script src="styles/Gresik_32_style.js"></script>
  <script src="styles/Bangkalan_33_style.js"></script>
  <script src="styles/Sampang_34_style.js"></script>
  <script src="styles/Pamekasan_35_style.js"></script>
  <script src="styles/Sumenep_36_style.js"></script>
  <script src="styles/Surabaya_37_style.js"></script>
  <script src="styles/Batu_38_style.js"></script>
  <script src="styles/BatasKabupaten_39_style.js"></script>

  <!-- Main script -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Daftar layer kabupaten/kota
      const kabupatenLayers = [
        lyr_Pacitan_1, lyr_Ponorogo_2, lyr_Trenggalek_3, lyr_Tulungagung_4,
        lyr_Blitar_5, lyr_KotaBlitar_6, lyr_Kediri_7, lyr_KotaKediri_8,
        lyr_Malang_9, lyr_KotaMalang_10, lyr_Lumajang_11, lyr_Jember_12,
        lyr_Banyuwangi_13, lyr_Bondowoso_14, lyr_Situbondo_15, lyr_Probolinggo_16,
        lyr_KotaProbolinggo_17, lyr_Pasuruan_18, lyr_KotaPasuruan_19, lyr_Sidoarjo_20,
        lyr_Mojokerto_21, lyr_KotaMojokerto_22, lyr_Jombang_23, lyr_Ngajuk_24,
        lyr_Madiun_25, lyr_KotaMadiun_26, lyr_Magetan_27, lyr_Ngawi_28,
        lyr_Bojonegoro_29, lyr_Tuban_30, lyr_Lamongan_31, lyr_Gresik_32,
        lyr_Bangkalan_33, lyr_Sampang_34, lyr_Pamekasan_35, lyr_Sumenep_36,
        lyr_Surabaya_37, lyr_Batu_38
      ];

      // Inisialisasi peta
      const map = new ol.Map({
        target: 'map',
        layers: [
          lyr_GoogleSatellite_0,
          new ol.layer.Group({
            layers: kabupatenLayers,
            title: 'Cluster ESG per Kabupaten/Kota Jawa Timur'
          }),
          lyr_BatasKabupaten_39
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat([112.5, -7.2]),
          zoom: 7
        })
      });

      // Isi dropdown kabupaten
      const kabSelect = document.getElementById('kabupatenSelect');
      kabupatenLayers.forEach((layer, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = layer.get('title').split('<br />')[0];
        kabSelect.appendChild(option);
      });

      // Hover interaction - highlight style
      let hoverInteraction = new ol.interaction.Select({
        condition: ol.events.condition.pointerMove,
        layers: kabupatenLayers,
        style: new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: 'yellow',
            width: 3
          }),
          fill: new ol.style.Fill({
            color: 'rgba(255, 255, 0, 0.3)'
          })
        })
      });
      map.addInteraction(hoverInteraction);

      // Popup overlay
      const popupEl = document.getElementById('popup');
      const popupCloser = document.getElementById('popup-closer');
      const popupContent = document.getElementById('popup-content');
      const overlay = new ol.Overlay({
        element: popupEl,
        autoPan: {
          animation: {
            duration: 250
          }
        }
      });
      map.addOverlay(overlay);
      
      popupCloser.onclick = function(e) {
        overlay.setPosition(undefined);
        popupEl.style.display = 'none';
        e.preventDefault();
      };

      // Click on feature popup
      map.on('singleclick', function(evt) {
        const feature = map.forEachFeatureAtPixel(evt.pixel, function(f) {
          return f;
        });
        
        if (feature) {
          const props = feature.getProperties();
          const nama = props['NAMOBJ'] || props['nmkab'] || 'Tidak diketahui';
          const cluster = props['Cluster'] || 'Tidak diketahui';
          
          popupContent.innerHTML = `
            <strong>${nama}</strong><br>
            Cluster: ${cluster}<br>
            ESG: ${props['ESG'] || 'Tidak diketahui'}
          `;
          
          overlay.setPosition(evt.coordinate);
          popupEl.style.display = 'block';
        } else {
          overlay.setPosition(undefined);
          popupEl.style.display = 'none';
        }
      });

      // Dropdown change handler: focus on selected kabupaten
      kabSelect.addEventListener('change', function() {
        const idx = this.value;
        
        if (idx === '') {
          // Reset semua layer ke opacity 1
          kabupatenLayers.forEach(layer => layer.setOpacity(1));
          
          // Zoom ke seluruh Jawa Timur
          map.getView().animate({
            center: ol.proj.fromLonLat([112.5, -7.2]),
            zoom: 7,
            duration: 500
          });
          
          // Update hover interaction ke semua layer
          map.removeInteraction(hoverInteraction);
          hoverInteraction = new ol.interaction.Select({
            condition: ol.events.condition.pointerMove,
            layers: kabupatenLayers,
            style: new ol.style.Style({
              stroke: new ol.style.Stroke({
                color: 'yellow',
                width: 3
              }),
              fill: new ol.style.Fill({
                color: 'rgba(255, 255, 0, 0.3)'
              })
            })
          });
          map.addInteraction(hoverInteraction);
          
          return;
        }
        
        // Fokus layer terpilih: opacity 1, yang lain opacity 0.3
        kabupatenLayers.forEach((layer, i) => {
          layer.setOpacity(i == idx ? 1 : 0.3);
        });
        
        // Zoom ke extent kabupaten yang dipilih
        const extent = kabupatenLayers[idx].getSource().getExtent();
        if (extent && !ol.extent.isEmpty(extent)) {
          map.getView().fit(extent, {
            padding: [50, 50, 50, 50],
            maxZoom: 10,
            duration: 500
          });
        }

        // Update hover interaction ke layer yg dipilih saja
        map.removeInteraction(hoverInteraction);
        hoverInteraction = new ol.interaction.Select({
          condition: ol.events.condition.pointerMove,
          layers: [kabupatenLayers[idx]],
          style: new ol.style.Style({
            stroke: new ol.style.Stroke({
              color: 'yellow',
              width: 3
            }),
            fill: new ol.style.Fill({
              color: 'rgba(255, 255, 0, 0.3)'
            })
          })
        });
        map.addInteraction(hoverInteraction);

        // Clear popup
        overlay.setPosition(undefined);
        popupEl.style.display = 'none';
      });

      // Reset button handler
      document.getElementById('btnReset').addEventListener('click', function() {
        kabSelect.value = '';
        
        // Trigger change event
        const event = new Event('change');
        kabSelect.dispatchEvent(event);
      });
    });
  </script>
</body>
</html>
