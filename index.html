<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  
  <link rel="stylesheet" href="./resources/ol.css">
  <link rel="stylesheet" href="resources/fontawesome-all.min.css">
  <link href="resources/photon-geocoder-autocomplete.min.css" rel="stylesheet">
  <link rel="stylesheet" href="./resources/ol-layerswitcher.css">
  <link rel="stylesheet" href="./resources/qgis2web.css">

  <style>
    /* Basic Layout */
    html, body, #map {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      overflow: hidden;
    }

    /* Styling untuk kontrol OpenLayers bawaan */
    .ol-control > * {
      background-color: #f8f8f8!important;
      color: #444444!important;
      border-radius: 0px;
    }
    .ol-attribution a, .gcd-gl-input::placeholder, .search-layer-input-search::placeholder {
      color: #444444!important;
    }
    .search-layer-input-search {
      background-color: #f8f8f8!important;
    }
    .ol-control > *:focus, .ol-control >*:hover {
      background-color: rgba(248, 248, 248, 0.7)!important;
    }
    .ol-control {
      background-color: rgba(255,255,255,.4) !important;
      padding: 2px !important;
    }

    /* Styling untuk Panel Kontrol Kustom */
    #topbar {
      position: absolute;
      left: 10px;
      top: 10px;
      z-index: 1100;
      background: rgba(255,255,255,0.95);
      padding: 8px 10px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      max-width: calc(100vw - 40px);
    }
    label {
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
    }
    select, input, button {
      padding: 6px 10px;
      font-size: 13px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: inherit;
      outline: none;
      min-width: 150px;
    }
    button {
      cursor: pointer;
    }

    /* Styling untuk Popup */
    .ol-popup {
      position: absolute;
      background-color: white;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 10px;
      border: 1px solid #cccccc;
      bottom: 12px;
      left: -50px;
      min-width: 200px;
      font-size: 13px;
    }
    .ol-popup-closer {
      text-decoration: none;
      position: absolute;
      top: 2px;
      right: 8px;
      font-weight: bold;
      font-size: 18px;
    }
  </style>
  <title>Peta Interaktif Jawa Timur</title>
</head>
<body>
  <div id="topbar">
    <label for="kabupatenSelect">Pilih Kabupaten/Kota:</label>
    <select id="kabupatenSelect"><option value="">-- Semua Kabupaten --</option></select>
    <label for="searchDesa">Cari Desa:</label>
    <input id="searchDesa" placeholder="ketik nama desa lalu Enter" />
    <button id="btnReset">Reset</button>
  </div>

  <div id="map">
    <div id="popup" class="ol-popup">
      <a href="#" id="popup-closer" class="ol-popup-closer"></a>
      <div id="popup-content"></div>
    </div>
  </div>
  
  <script src="resources/qgis2web_expressions.js"></script>
  <script src="./resources/functions.js"></script>
  <script src="./resources/ol.js"></script>
  <script src="./resources/ol-layerswitcher.js"></script>
  <script src="resources/photon-geocoder-autocomplete.min.js"></script>
  
  <script src="layers/Pacitan_1.js"></script><script src="layers/Ponorogo_2.js"></script><script src="layers/Trenggalek_3.js"></script><script src="layers/Tulungagung_4.js"></script><script src="layers/Blitar_5.js"></script><script src="layers/KotaBlitar_6.js"></script><script src="layers/Kediri_7.js"></script><script src="layers/KotaKediri_8.js"></script><script src="layers/Malang_9.js"></script><script src="layers/KotaMalang_10.js"></script><script src="layers/Lumajang_11.js"></script><script src="layers/Jember_12.js"></script><script src="layers/Banyuwangi_13.js"></script><script src="layers/Bondowoso_14.js"></script><script src="layers/Situbondo_15.js"></script><script src="layers/Probolinggo_16.js"></script><script src="layers/KotaProbolinggo_17.js"></script><script src="layers/Pasuruan_18.js"></script><script src="layers/KotaPasuruan_19.js"></script><script src="layers/Sidoarjo_20.js"></script><script src="layers/Mojokerto_21.js"></script><script src="layers/KotaMojokerto_22.js"></script><script src="layers/Jombang_23.js"></script><script src="layers/Ngajuk_24.js"></script><script src="layers/Madiun_25.js"></script><script src="layers/KotaMadiun_26.js"></script><script src="layers/Magetan_27.js"></script><script src="layers/Ngawi_28.js"></script><script src="layers/Bojonegoro_29.js"></script><script src="layers/Tuban_30.js"></script><script src="layers/Lamongan_31.js"></script><script src="layers/Gresik_32.js"></script><script src="layers/Bangkalan_33.js"></script><script src="layers/Sampang_34.js"></script><script src="layers/Pamekasan_35.js"></script><script src="layers/Sumenep_36.js"></script><script src="layers/Surabaya_37.js"></script><script src="layers/Batu_38.js"></script><script src="layers/BatasKabupaten_39.js"></script>
  
  <script src="styles/Pacitan_1_style.js"></script><script src="styles/Ponorogo_2_style.js"></script><script src="styles/Trenggalek_3_style.js"></script><script src="styles/Tulungagung_4_style.js"></script><script src="styles/Blitar_5_style.js"></script><script src="styles/KotaBlitar_6_style.js"></script><script src="styles/Kediri_7_style.js"></script><script src="styles/KotaKediri_8_style.js"></script><script src="styles/Malang_9_style.js"></script><script src="styles/KotaMalang_10_style.js"></script><script src="styles/Lumajang_11_style.js"></script><script src="styles/Jember_12_style.js"></script><script src="styles/Banyuwangi_13_style.js"></script><script src="styles/Bondowoso_14_style.js"></script><script src="styles/Situbondo_15_style.js"></script><script src="styles/Probolinggo_16_style.js"></script><script src="styles/KotaProbolinggo_17_style.js"></script><script src="styles/Pasuruan_18_style.js"></script><script src="styles/KotaPasuruan_19_style.js"></script><script src="styles/Sidoarjo_20_style.js"></script><script src="styles/Mojokerto_21_style.js"></script><script src="styles/KotaMojokerto_22_style.js"></script><script src="styles/Jombang_23_style.js"></script><script src="styles/Ngajuk_24_style.js"></script><script src="styles/Madiun_25_style.js"></script><script src="styles/KotaMadiun_26_style.js"></script><script src="styles/Magetan_27_style.js"></script><script src="styles/Ngawi_28_style.js"></script><script src="styles/Bojonegoro_29_style.js"></script><script src="styles/Tuban_30_style.js"></script><script src="styles/Lamongan_31_style.js"></script><script src="styles/Gresik_32_style.js"></script><script src="styles/Bangkalan_33_style.js"></script><script src="styles/Sampang_34_style.js"></script><script src="styles/Pamekasan_35_style.js"></script><script src="styles/Sumenep_36_style.js"></script><script src="styles/Surabaya_37_style.js"></script><script src="styles/Batu_38_style.js"></script><script src="styles/BatasKabupaten_39_style.js"></script>
  
  <script src="./layers/layers.js" type="text/javascript"></script>
  <script src="./resources/Autolinker.min.js"></script>
  <script src="./resources/qgis2web.js"></script>
  
  <script>
    (function(){
      function waitForCondition(conditionFn, interval=100, timeout=10000){
        return new Promise((resolve, reject)=>{
          const start = Date.now();
          (function check(){
            if(conditionFn()) return resolve(true);
            if(Date.now() - start > timeout) return reject(new Error('Timeout menunggu kondisi.'));
            setTimeout(check, interval);
          })();
        });
      }
      
      // Menunggu map dan layer batas kabupaten siap
      const areAllVarsDefined = () => typeof map !== 'undefined' && typeof layer_BatasKabupaten_39 !== 'undefined';

      waitForCondition(areAllVarsDefined).then(() => {
        console.log("Peta dasar dan semua layer telah dimuat. Menjalankan skrip kustom.");
        
        // --- DEFINISI DATA & VARIABEL ---
        const kabupatenData = [
            { name: 'Pacitan', layer: layer_Pacitan_1 }, { name: 'Ponorogo', layer: layer_Ponorogo_2 },
            { name: 'Trenggalek', layer: layer_Trenggalek_3 }, { name: 'Tulungagung', layer: layer_Tulungagung_4 },
            { name: 'Blitar', layer: layer_Blitar_5 }, { name: 'Kota Blitar', layer: layer_KotaBlitar_6 },
            { name: 'Kediri', layer: layer_Kediri_7 }, { name: 'Kota Kediri', layer: layer_KotaKediri_8 },
            { name: 'Malang', layer: layer_Malang_9 }, { name: 'Kota Malang', layer: layer_KotaMalang_10 },
            { name: 'Lumajang', layer: layer_Lumajang_11 }, { name: 'Jember', layer: layer_Jember_12 },
            { name: 'Banyuwangi', layer: layer_Banyuwangi_13 }, { name: 'Bondowoso', layer: layer_Bondowoso_14 },
            { name: 'Situbondo', layer: layer_Situbondo_15 }, { name: 'Probolinggo', layer: layer_Probolinggo_16 },
            { name: 'Kota Probolinggo', layer: layer_KotaProbolinggo_17 }, { name: 'Pasuruan', layer: layer_Pasuruan_18 },
            { name: 'Kota Pasuruan', layer: layer_KotaPasuruan_19 }, { name: 'Sidoarjo', layer: layer_Sidoarjo_20 },
            { name: 'Mojokerto', layer: layer_Mojokerto_21 }, { name: 'Kota Mojokerto', layer: layer_KotaMojokerto_22 },
            { name: 'Jombang', layer: layer_Jombang_23 }, { name: 'Nganjuk', layer: layer_Ngajuk_24 },
            { name: 'Madiun', layer: layer_Madiun_25 }, { name: 'Kota Madiun', layer: layer_KotaMadiun_26 },
            { name: 'Magetan', layer: layer_Magetan_27 }, { name: 'Ngawi', layer: layer_Ngawi_28 },
            { name: 'Bojonegoro', layer: layer_Bojonegoro_29 }, { name: 'Tuban', layer: layer_Tuban_30 },
            { name: 'Lamongan', layer: layer_Lamongan_31 }, { name: 'Gresik', layer: layer_Gresik_32 },
            { name: 'Bangkalan', layer: layer_Bangkalan_33 }, { name: 'Sampang', layer: layer_Sampang_34 },
            { name: 'Pamekasan', layer: layer_Pamekasan_35 }, { name: 'Sumenep', layer: layer_Sumenep_36 },
            { name: 'Kota Surabaya', layer: layer_Surabaya_37 }, { name: 'Kota Batu', layer: layer_Batu_38 }
        ];

        const allKabupatenLayers = kabupatenData.map(d => d.layer);
        const kabSelect = document.getElementById('kabupatenSelect');
        const searchInput = document.getElementById('searchDesa');
        const resetButton = document.getElementById('btnReset');
        const popupEl = document.getElementById('popup');
        const popupContent = document.getElementById('popup-content');
        let hoverInteraction = null;
        let clickInteraction = null;
        
        // --- SETUP POPUP & STYLE ---
        const overlay = new ol.Overlay({ 
          element: popupEl, 
          autoPan: { 
            animation: { 
              duration: 250 
            } 
          } 
        });
        map.addOverlay(overlay);
        
        document.getElementById('popup-closer').onclick = () => { 
          overlay.setPosition(undefined); 
          return false; 
        };

        // Style untuk hover yang lebih menonjol
        const highlightStyle = new ol.style.Style({
          stroke: new ol.style.Stroke({ 
            color: '#ff0000', 
            width: 4 
          }),
          fill: new ol.style.Fill({ 
            color: 'rgba(255, 0, 0, 0.3)' 
          }),
          zIndex: 100
        });
        
        // --- FUNGSI UTAMA ---
        function enableHoverInteraction(layers) {
          // Hapus interaksi hover sebelumnya jika ada
          if (hoverInteraction) {
            map.removeInteraction(hoverInteraction);
          }
          
          // Buat interaksi hover baru
          hoverInteraction = new ol.interaction.Select({
            condition: ol.events.condition.pointerMove,
            layers: Array.isArray(layers) ? layers : [layers],
            style: highlightStyle,
            hitTolerance: 5 // Memberikan toleransi untuk mempermudah hover
          });
          
          // Event ketika feature terhover
          hoverInteraction.on('select', function(e) {
            const mapTarget = map.getTargetElement();
            
            // Ubah cursor ketika hover
            mapTarget.style.cursor = e.selected.length > 0 ? 'pointer' : '';
            
            // Tampilkan popup info saat hover
            if (e.selected.length > 0) {
              const feature = e.selected[0];
              showFeatureInfo(feature, true);
            } else {
              overlay.setPosition(undefined);
            }
          });
          
          map.addInteraction(hoverInteraction);
        }
        
        function enableClickInteraction(layers) {
          // Hapus interaksi klik sebelumnya jika ada
          if (clickInteraction) {
            map.removeInteraction(clickInteraction);
          }
          
          // Buat interaksi klik baru
          clickInteraction = new ol.interaction.Select({
            condition: ol.events.condition.click,
            layers: Array.isArray(layers) ? layers : [layers],
            style: highlightStyle
          });
          
          // Event ketika feature diklik
          clickInteraction.on('select', function(e) {
            if (e.selected.length > 0) {
              const feature = e.selected[0];
              showFeatureInfo(feature, false);
            } else {
              overlay.setPosition(undefined);
            }
          });
          
          map.addInteraction(clickInteraction);
        }
        
        function showFeatureInfo(feature, isHover) {
          const props = feature.getProperties();
          const name = props['NAMOBJ'] || props['NAME_3'] || props['NAMA_DESA'] || props['NAME_2'];
          const kabupaten = props['NAME_2'] || '-';
          
          popupContent.innerHTML = `
            <strong>Desa/Kel:</strong> ${name || '-'}<br>
            <strong>Kab/Kota:</strong> ${kabupaten}
          `;
          
          // Dapatkan koordinat tengah feature
          const geometry = feature.getGeometry();
          let coord;
          
          if (geometry.getType() === 'Polygon' || geometry.getType() === 'MultiPolygon') {
            coord = ol.extent.getCenter(geometry.getExtent());
          } else {
            coord = geometry.getCoordinates();
          }
          
          overlay.setPosition(coord);
          
          // Jika ini hover (bukan klik), atur timeout untuk menyembunyikan popup
          if (isHover) {
            clearTimeout(window.hoverTimeout);
            window.hoverTimeout = setTimeout(() => {
              overlay.setPosition(undefined);
            }, 2000);
          }
        }

        function resetMapView() {
          // Tampilkan semua layer kabupaten
          allKabupatenLayers.forEach(lyr => lyr.setVisible(true));
          layer_BatasKabupaten_39.setVisible(true);
          
          // Reset ke view awal
          const combinedExtent = kabSelect.options[0].extent;
          if (combinedExtent) {
            map.getView().fit(combinedExtent, { 
              padding: [50, 50, 50, 50], 
              duration: 500 
            });
          }
          
          // Aktifkan hover untuk semua layer
          enableHoverInteraction(allKabupatenLayers);
          enableClickInteraction(allKabupatenLayers);
          
          // Reset form
          overlay.setPosition(undefined);
          kabSelect.value = '';
          searchInput.value = '';
        }

        // --- INISIALISASI KONTROL & PETA ---
        let combinedExtent = ol.extent.createEmpty();
        
        // Isi dropdown kabupaten
        kabupatenData.forEach((item, index) => {
          const opt = document.createElement('option');
          opt.value = index;
          opt.textContent = item.name;
          const extent = item.layer.getSource().getExtent();
          
          if (extent && !ol.extent.isEmpty(extent)) {
            opt.extent = extent;
            ol.extent.extend(combinedExtent, extent);
          }
          
          kabSelect.appendChild(opt);
        });
        
        if (!ol.extent.isEmpty(combinedExtent)) {
          kabSelect.options[0].extent = combinedExtent;
        }
        
        // Atur tampilan awal
        resetMapView();

        // --- EVENT LISTENERS ---
        kabSelect.addEventListener('change', function() {
          const selectedIndex = this.value;
          
          if (selectedIndex === '') {
            resetMapView();
            return;
          }
          
          const idx = parseInt(selectedIndex, 10);
          const selectedItem = kabupatenData[idx];
          
          // Sembunyikan semua layer kecuali yang dipilih
          allKabupatenLayers.forEach((lyr, i) => lyr.setVisible(i === idx));
          
          // Zoom ke kabupaten yang dipilih
          const extent = this.options[this.selectedIndex].extent;
          if (extent) {
            map.getView().fit(extent, { 
              padding: [50, 50, 50, 50], 
              maxZoom: 12, 
              duration: 500 
            });
          }
          
          // Aktifkan hover hanya untuk layer yang dipilih
          enableHoverInteraction(selectedItem.layer);
          enableClickInteraction(selectedItem.layer);
          
          overlay.setPosition(undefined);
        });

        resetButton.addEventListener('click', resetMapView);
        
        // Handle pencarian desa
        searchInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            const searchTerm = this.value.trim().toLowerCase();
            
            if (!searchTerm) {
              return;
            }
            
            let foundFeature = null;
            let foundLayer = null;
            
            // Cari di semua layer kabupaten yang visible
            allKabupatenLayers.forEach(layer => {
              if (!layer.getVisible()) return;
              
              layer.getSource().forEachFeature(feature => {
                const props = feature.getProperties();
                const name = (props['NAMOBJ'] || props['NAME_3'] || props['NAMA_DESA'] || '').toLowerCase();
                
                if (name.includes(searchTerm)) {
                  foundFeature = feature;
                  foundLayer = layer;
                }
              });
            });
            
            if (foundFeature && foundLayer) {
              // Zoom ke feature yang ditemukan
              const extent = foundFeature.getGeometry().getExtent();
              map.getView().fit(extent, {
                padding: [50, 50, 50, 50],
                duration: 500,
                maxZoom: 14
              });
              
              // Tampilkan info
              showFeatureInfo(foundFeature, false);
            } else {
              alert('Desa tidak ditemukan!');
            }
          }
        });

      }).catch(err => {
        console.error("Gagal menjalankan skrip kustom:", err);
        alert("Terjadi kesalahan saat memuat fungsionalitas peta. Silakan periksa konsol (F12) untuk detail.");
      });
    })();
  </script>
</body>
</html>
