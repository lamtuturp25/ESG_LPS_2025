<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width-device-width">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  
  <link rel="stylesheet" href="./resources/ol.css">
  <link rel="stylesheet" href="resources/fontawesome-all.min.css">
  <link rel="stylesheet" href="./resources/qgis2web.css">

  <style>
    html, body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
        overflow: hidden;
    }
    #app-container {
        display: flex;
        height: 100%;
        width: 100%;
    }
    #sidebar {
        width: 320px;
        flex-shrink: 0;
        background-color: #f8f9fa;
        padding: 20px;
        box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        overflow-y: auto;
        z-index: 1000;
    }
    #map {
        flex-grow: 1;
        height: 100%;
        position: relative;
    }
    #sidebar h1 {
        font-size: 20px;
        color: #333;
        margin-top: 0;
        margin-bottom: 20px;
        line-height: 1.3;
    }
    .legend-section, .search-section {
        margin-bottom: 25px;
    }
    .legend-section h2, .search-section h2 {
        font-size: 16px;
        border-bottom: 1px solid #ddd;
        padding-bottom: 8px;
        margin-bottom: 15px;
    }
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }
    .legend-color {
        width: 20px;
        height: 20px;
        margin-right: 10px;
        border: 1px solid #888;
    }
    #search-input {
        width: 100%;
        padding: 8px;
        font-size: 14px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
    }
    /* STYLE POPUP YANG DIPERBAIKI */
    .ol-popup {
        position: absolute;
        background-color: white;
        box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #cccccc;
        min-width: 280px;
        font-size: 14px;
        z-index: 1000;
        display: none;
    }
    .ol-popup:after, .ol-popup:before {
        top: 100%;
        border: solid transparent;
        content: " ";
        height: 0;
        width: 0;
        position: absolute;
        pointer-events: none;
    }
    .ol-popup:after {
        border-top-color: white;
        border-width: 10px;
        left: 50%;
        margin-left: -10px;
    }
    .ol-popup:before {
        border-top-color: #cccccc;
        border-width: 11px;
        left: 50%;
        margin-left: -11px;
    }
    .ol-popup-closer {
        text-decoration: none;
        position: absolute;
        top: 5px;
        right: 8px;
        font-size: 18px;
        color: #666;
    }
    .ol-popup-closer:hover {
        color: #000;
    }
    #popup-content h3 {
        margin: 0 0 5px 0;
        font-size: 16px;
        color: #000;
        padding-right: 15px;
    }
    #popup-content h4 {
        margin: 0 0 10px 0;
        font-size: 14px;
        color: #555;
        font-weight: normal;
    }
    #popup-content hr {
        border: 0;
        border-top: 1px solid #eee;
        margin: 10px 0;
    }
    .popup-table {
        width: 100%;
        border-spacing: 0;
        font-size: 13px;
    }
    .popup-table td {
        padding: 4px 0;
        vertical-align: top;
    }
    .popup-table td:first-child {
        font-weight: 500;
        color: #333;
        width: 120px;
    }
  </style>
  <title>Peta Persebaran ESG Jawa Timur</title>
</head>
<body>
  <div id="app-container">
    <div id="sidebar">
        <h1>Peta Persebaran ESG Jawa Timur</h1>
        
        <div class="legend-section">
            <h2>Legend Klaster</h2>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #85b66f;"></div>
                <span>Klaster 1</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #fec980;"></div>
                <span>Klaster 2</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #ff0900;"></div>
                <span>Klaster 3</span>
            </div>
        </div>

        <div class="search-section">
            <h2>Pilih Kabupaten / Kota</h2>
            <input type="text" id="search-input" placeholder="Ketik nama lalu Enter...">
        </div>
    </div>

    <div id="map">
        <div id="popup" class="ol-popup">
            <a href="#" id="popup-closer" class="ol-popup-closer">&times;</a>
            <div id="popup-content"></div>
        </div>
    </div>
  </div>
  
  <!-- Semua skrip asli dari qgis2web -->
  <script src="resources/qgis2web_expressions.js"></script>
  <script src="./resources/functions.js"></script>
  <script src="./resources/ol.js"></script>
  <script src="./resources/ol-layerswitcher.js"></script>
  <script src="layers/Pacitan_1.js"></script>
  <!-- [Script layer lainnya tetap sama] -->
  <script src="./layers/layers.js" type="text/javascript"></script>
  <script src="./resources/Autolinker.min.js"></script>
  <script src="./resources/qgis2web.js"></script>
  
  <script>
    function initializeCustomFeatures() {
        console.log("Peta siap. Memulai skrip kustom.");

        // 1. GABUNGKAN SEMUA LAYER DESA
        const allJsonData = [
            json_Pacitan_1, json_Ponorogo_2, json_Trenggalek_3, /* ... semua layer desa ... */
        ];
        
        const allStyleFunctions = [
            style_Pacitan_1, style_Ponorogo_2, style_Trenggalek_3, /* ... semua style ... */
        ];

        let allDesaFeatures = [];
        allJsonData.forEach((jsonData, index) => {
            if (typeof jsonData !== 'undefined') {
                const format = new ol.format.GeoJSON();
                const features = format.readFeatures(jsonData, {
                    dataProjection: 'EPSG:4326',
                    featureProjection: 'EPSG:3857'
                });
                const styleFunction = allStyleFunctions[index];
                features.forEach(feature => {
                    feature.set('original_style', styleFunction);
                    allDesaFeatures.push(feature);
                });
            }
        });
        
        // Sembunyikan layer yang tidak perlu
        map.getLayers().forEach(layer => {
            if (layer.get('title') !== 'BatasKabupaten' && layer !== map.getLayers().getArray()[0]) {
                layer.setVisible(false);
            }
        });

        // Buat layer gabungan semua desa
        const desaSource = new ol.source.Vector({ features: allDesaFeatures });
        const desaLayer = new ol.layer.Vector({
            source: desaSource,
            style: function(feature, resolution) {
                return feature.get('original_style')(feature, resolution);
            },
            title: 'Semua Desa'
        });
        map.addLayer(desaLayer);
        console.log(`Berhasil menggabungkan ${allDesaFeatures.length} desa.`);

        // 2. FUNGSI PENCARIAN
        const searchInput = document.getElementById('search-input');
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const searchTerm = this.value.trim().toLowerCase();
                if (searchTerm === '') {
                    desaSource.clear();
                    desaSource.addFeatures(allDesaFeatures);
                    return;
                }
                
                const filteredFeatures = allDesaFeatures.filter(feature => {
                    const namaKab = (feature.get('WADMKK') || '').toLowerCase();
                    return namaKab.includes(searchTerm);
                });

                desaSource.clear();
                desaSource.addFeatures(filteredFeatures);

                if (filteredFeatures.length > 0) {
                    map.getView().fit(desaSource.getExtent(), {
                        padding: [50, 50, 50, 50],
                        maxZoom: 11,
                        duration: 500
                    });
                } else {
                    alert('Kabupaten/Kota tidak ditemukan.');
                    desaSource.clear();
                    desaSource.addFeatures(allDesaFeatures);
                }
            }
        });

        // 3. FUNGSI POPUP YANG DIPERBAIKI
        const popup = document.getElementById('popup');
        const popupContent = document.getElementById('popup-content');
        const popupCloser = document.getElementById('popup-closer');
        
        // Buat overlay popup
        const overlay = new ol.Overlay({
            element: popup,
            autoPan: {
                animation: {
                    duration: 250
                }
            },
            autoPanMargin: 20,
            positioning: 'bottom-center'
        });
        map.addOverlay(overlay);
        
        // Tutup popup saat klik tombol close
        popupCloser.onclick = function(e) {
            overlay.setPosition(undefined);
            popup.style.display = 'none';
            e.preventDefault();
            return false;
        };

        // Format nilai untuk ditampilkan
        function safeValue(value, decimalPlaces = 4) {
            if (value === null || value === undefined || value === '') return '-';
            if (typeof value === 'number') return value.toFixed(decimalPlaces);
            return value;
        }

        // Handle klik pada peta
        map.on('singleclick', function(evt) {
            overlay.setPosition(undefined);
            popup.style.display = 'none';
            
            // Cari feature yang diklik dengan toleransi
            const feature = map.forEachFeatureAtPixel(evt.pixel, function(f) {
                return f;
            }, {
                hitTolerance: 10,
                layerFilter: function(layer) {
                    return layer === desaLayer;
                }
            });

            if (feature) {
                try {
                    const props = feature.getProperties();
                    console.log("Feature clicked:", props); // Debugging
                    
                    const clusterValue = parseInt(props['Cluster'], 10);
                    const klasterText = !isNaN(clusterValue) ? `Klaster ${clusterValue + 1}` : 'Klaster -';

                    // Buat konten popup
                    const content = `
                        <h3>${safeValue(props['NAMOBJ'])}</h3>
                        <h4>${klasterText}</h4>
                        <hr>
                        <table class="popup-table">
                            <tr><td>Nama Kecamatan</td><td>: ${safeValue(props['WADMKC'])}</td></tr>
                            <tr><td>Nama Kabupaten</td><td>: ${safeValue(props['WADMKK'])}</td></tr>
                            <tr><td>Nilai Environmental</td><td>: ${safeValue(props['E'])}</td></tr>
                            <tr><td>Nilai Social</td><td>: ${safeValue(props['S'])}</td></tr>
                            <tr><td>Nilai Governance</td><td>: ${safeValue(props['G'])}</td></tr>
                            <tr><td>Nilai ESG</td><td>: ${safeValue(props['ESG'])}</td></tr>
                        </table>
                    `;
                    
                    popupContent.innerHTML = content;
                    overlay.setPosition(evt.coordinate);
                    popup.style.display = 'block';
                    
                } catch (err) {
                    console.error("Error creating popup content:", err);
                    popupContent.innerHTML = "Error loading feature data";
                    overlay.setPosition(evt.coordinate);
                    popup.style.display = 'block';
                }
            }
        });

        // Highlight feature saat hover
        let selected = null;
        const highlightStyle = new ol.style.Style({
            stroke: new ol.style.Stroke({
                color: 'rgba(255, 255, 0, 1)',
                width: 3
            }),
            fill: new ol.style.Fill({
                color: 'rgba(255, 255, 0, 0.3)'
            })
        });

        map.on('pointermove', function(e) {
            if (e.dragging) return;
            
            if (selected) {
                selected.setStyle(selected.get('original_style')(selected, map.getView().getResolution()));
                selected = null;
            }
            
            map.forEachFeatureAtPixel(e.pixel, function(f, l) {
                if (l === desaLayer) {
                    selected = f;
                    f.setStyle(highlightStyle);
                    map.getTargetElement().style.cursor = 'pointer';
                    return true;
                }
            });
            
            map.getTargetElement().style.cursor = selected ? 'pointer' : '';
        });
    };

    // Tunggu hingga semua komponen siap
    const mapReadyCheck = setInterval(function() {
        if (typeof map !== 'undefined' && typeof ol !== 'undefined' && 
            typeof json_Pacitan_1 !== 'undefined' && typeof style_Pacitan_1 !== 'undefined') {
            clearInterval(mapReadyCheck);
            initializeCustomFeatures();
        }
    }, 100);
  </script>
</body>
</html>
