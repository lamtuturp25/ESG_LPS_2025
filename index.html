<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="stylesheet" href="./resources/ol.css">
    <link rel="stylesheet" href="resources/fontawesome-all.min.css">
    <link href="resources/photon-geocoder-autocomplete.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./resources/ol-layerswitcher.css">
    <link rel="stylesheet" href="./resources/qgis2web.css">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }
        #map {
            width: 100%;
            height: 100%;
        }
        .ol-control > * {
            background-color: #f8f8f8!important;
            color: #444444!important;
            border-radius: 0px;
        }
        .ol-attribution a, .gcd-gl-input::placeholder, .search-layer-input-search::placeholder {
            color: #444444!important;
        }
        .search-layer-input-search {
            background-color: #f8f8f8!important;
        }
        .ol-control > *:focus, .ol-control >*:hover {
            background-color: rgba(248, 248, 248, 0.7)!important;
        } 
        .ol-control {
            background-color: rgba(255,255,255,.4) !important;
            padding: 2px !important;
        } 
        #controls {
            position: absolute;
            top: 10px;
            left: 50px;
            z-index: 1000;
            background: white;
            padding: 5px;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
    </style>
    <title>Peta Kabupaten/Kota dan Desa</title>
</head>
<body>
    <div id="controls">
        <select id="kabupatenDropdown">
            <option value="">-- Pilih Kabupaten/Kota --</option>
        </select>
        <input type="text" id="desaSearch" placeholder="Cari Desa..." />
    </div>
    <div id="map">
        <div id="popup" class="ol-popup">
            <a href="#" id="popup-closer" class="ol-popup-closer"></a>
            <div id="popup-content"></div>
        </div>
    </div>

    <script src="resources/qgis2web_expressions.js"></script>
    <script src="./resources/functions.js"></script>
    <script src="./resources/ol.js"></script>
    <script src="./resources/ol-layerswitcher.js"></script>
    <script src="resources/photon-geocoder-autocomplete.min.js"></script>

    <!-- Semua file layer kabupaten/kota -->
    <script src="layers/Pacitan_1.js"></script>
    <script src="layers/Ponorogo_2.js"></script>
    <script src="layers/Trenggalek_3.js"></script>
    <script src="layers/Tulungagung_4.js"></script>
    <script src="layers/Blitar_5.js"></script>
    <script src="layers/KotaBlitar_6.js"></script>
    <script src="layers/Kediri_7.js"></script>
    <script src="layers/KotaKediri_8.js"></script>
    <script src="layers/Malang_9.js"></script>
    <script src="layers/KotaMalang_10.js"></script>
    <script src="layers/Lumajang_11.js"></script>
    <script src="layers/Jember_12.js"></script>
    <script src="layers/Banyuwangi_13.js"></script>
    <script src="layers/Bondowoso_14.js"></script>
    <script src="layers/Situbondo_15.js"></script>
    <script src="layers/Probolinggo_16.js"></script>
    <script src="layers/KotaProbolinggo_17.js"></script>
    <script src="layers/Pasuruan_18.js"></script>
    <script src="layers/KotaPasuruan_19.js"></script>
    <script src="layers/Sidoarjo_20.js"></script>
    <script src="layers/Mojokerto_21.js"></script>
    <script src="layers/KotaMojokerto_22.js"></script>
    <script src="layers/Jombang_23.js"></script>
    <script src="layers/Ngajuk_24.js"></script>
    <script src="layers/Madiun_25.js"></script>
    <script src="layers/KotaMadiun_26.js"></script>
    <script src="layers/Magetan_27.js"></script>
    <script src="layers/Ngawi_28.js"></script>
    <script src="layers/Bojonegoro_29.js"></script>
    <script src="layers/Tuban_30.js"></script>
    <script src="layers/Lamongan_31.js"></script>
    <script src="layers/Gresik_32.js"></script>
    <script src="layers/Bangkalan_33.js"></script>
    <script src="layers/Sampang_34.js"></script>
    <script src="layers/Pamekasan_35.js"></script>
    <script src="layers/Sumenep_36.js"></script>
    <script src="layers/Surabaya_37.js"></script>
    <script src="layers/Batu_38.js"></script>

    <!-- Semua style -->
    <script src="styles/Pacitan_1_style.js"></script>
    <script src="styles/Ponorogo_2_style.js"></script>
    <script src="styles/Trenggalek_3_style.js"></script>
    <script src="styles/Tulungagung_4_style.js"></script>
    <script src="styles/Blitar_5_style.js"></script>
    <script src="styles/KotaBlitar_6_style.js"></script>
    <script src="styles/Kediri_7_style.js"></script>
    <script src="styles/KotaKediri_8_style.js"></script>
    <script src="styles/Malang_9_style.js"></script>
    <script src="styles/KotaMalang_10_style.js"></script>
    <script src="styles/Lumajang_11_style.js"></script>
    <script src="styles/Jember_12_style.js"></script>
    <script src="styles/Banyuwangi_13_style.js"></script>
    <script src="styles/Bondowoso_14_style.js"></script>
    <script src="styles/Situbondo_15_style.js"></script>
    <script src="styles/Probolinggo_16_style.js"></script>
    <script src="styles/KotaProbolinggo_17_style.js"></script>
    <script src="styles/Pasuruan_18_style.js"></script>
    <script src="styles/KotaPasuruan_19_style.js"></script>
    <script src="styles/Sidoarjo_20_style.js"></script>
    <script src="styles/Mojokerto_21_style.js"></script>
    <script src="styles/KotaMojokerto_22_style.js"></script>
    <script src="styles/Jombang_23_style.js"></script>
    <script src="styles/Ngajuk_24_style.js"></script>
    <script src="styles/Madiun_25_style.js"></script>
    <script src="styles/KotaMadiun_26_style.js"></script>
    <script src="styles/Magetan_27_style.js"></script>
    <script src="styles/Ngawi_28_style.js"></script>
    <script src="styles/Bojonegoro_29_style.js"></script>
    <script src="styles/Tuban_30_style.js"></script>
    <script src="styles/Lamongan_31_style.js"></script>
    <script src="styles/Gresik_32_style.js"></script>
    <script src="styles/Bangkalan_33_style.js"></script>
    <script src="styles/Sampang_34_style.js"></script>
    <script src="styles/Pamekasan_35_style.js"></script>
    <script src="styles/Sumenep_36_style.js"></script>
    <script src="styles/Surabaya_37_style.js"></script>
    <script src="styles/Batu_38_style.js"></script>

    <script src="./layers/layers.js" type="text/javascript"></script> 
    <script src="./resources/Autolinker.min.js"></script>
    <script src="./resources/qgis2web.js"></script>

    <script>
        window.onload = function() {
            var kabupatenDropdown = document.getElementById('kabupatenDropdown');
            var desaSearch = document.getElementById('desaSearch');

            // Ambil semua layer vector kabupaten/kota
            map.getLayers().forEach(function(layer) {
                if (layer instanceof ol.layer.Vector && layer.get('title')) {
                    var option = document.createElement('option');
                    option.value = layer.get('title');
                    option.text = layer.get('title');
                    kabupatenDropdown.add(option);
                }
            });

            // Event pilih kabupaten/kota
            kabupatenDropdown.addEventListener('change', function() {
                var selectedLayerName = this.value;
                map.getLayers().forEach(function(layer) {
                    if (layer.get('title') === selectedLayerName) {
                        var extent = layer.getSource().getExtent();
                        map.getView().fit(extent, { duration: 1000 });
                    }
                });
            });

            // Event search desa (field WADMKD)
            desaSearch.addEventListener('change', function() {
                var searchVal = this.value.toLowerCase();
                map.getLayers().forEach(function(layer) {
                    if (layer instanceof ol.layer.Vector && layer.getVisible()) {
                        layer.getSource().forEachFeature(function(feature) {
                            var desaName = (feature.get('WADMKD') || '').toLowerCase();
                            if (desaName.includes(searchVal)) {
                                map.getView().fit(feature.getGeometry().getExtent(), { duration: 1000 });
                            }
                        });
                    }
                });
            });

            // Hover & popup
            var popupContainer = document.getElementById('popup');
            var popupContent = document.getElementById('popup-content');
            var popupCloser = document.getElementById('popup-closer');
            var overlay = new ol.Overlay({
                element: popupContainer,
                autoPan: true,
                autoPanAnimation: { duration: 250 }
            });
            map.addOverlay(overlay);
            popupCloser.onclick = function() {
                overlay.setPosition(undefined);
                popupCloser.blur();
                return false;
            };

            map.on('pointermove', function(evt) {
                var feature = map.forEachFeatureAtPixel(evt.pixel, function(ft) { return ft; });
                if (feature) {
                    var nama = feature.get('WADMKD') || feature.get('NAMOBJ') || 'Tidak ada nama';
                    popupContent.innerHTML = '<b>' + nama + '</b>';
                    overlay.setPosition(evt.coordinate);
                } else {
                    overlay.setPosition(undefined);
                }
            });
        };
    </script>
</body>
</html>
