<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  
  <link rel="stylesheet" href="./resources/ol.css">
  <link rel="stylesheet" href="resources/fontawesome-all.min.css">
  <link rel="stylesheet" href="./resources/qgis2web.css">

  <style>
    /* Membuat peta responsif dan menghilangkan style lama */
    html, body, #map { margin: 0; padding: 0; width: 100%; height: 100%; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; overflow: hidden; }
    /* Panel kontrol di atas peta */
    #topbar { position: absolute; left: 10px; top: 10px; z-index: 1100; background: white; padding: 8px 10px; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 10px; flex-wrap: wrap; max-width: calc(100vw - 40px); }
    label { font-size: 13px; font-weight: 600; white-space: nowrap; }
    select, button { padding: 6px 10px; font-size: 13px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; outline: none; min-width: 150px; }
    button { cursor: pointer; }
    /* Popup */
    .ol-popup { position: absolute; background-color: white; box-shadow: 0 1px 4px rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; border: 1px solid #cccccc; bottom: 12px; left: -50px; min-width: 280px; font-size: 14px; }
    .ol-popup-closer { text-decoration: none; position: absolute; top: 2px; right: 8px; font-weight: bold; }
    #popup-content { line-height: 1.8; }
  </style>
  <title>Peta Interaktif Jawa Timur</title>
</head>
<body>
  <!-- Elemen HTML untuk Dropdown -->
  <div id="topbar">
    <label for="kabupatenSelect">Pilih Kabupaten/Kota:</label>
    <select id="kabupatenSelect"><option>Memuat Peta...</option></select>
    <button id="btnReset">Reset</button>
  </div>

  <!-- Kontainer Peta dari qgis2web -->
  <div id="map">
    <div id="popup" class="ol-popup">
      <a href="#" id="popup-closer" class="ol-popup-closer"></a>
      <div id="popup-content"></div>
    </div>
  </div>
  
  <!-- Semua skrip asli dari qgis2web -->
  <script src="resources/qgis2web_expressions.js"></script>
  <script src="./resources/functions.js"></script>
  <script src="./resources/ol.js"></script>
  <script src="./resources/ol-layerswitcher.js"></script>
  <script src="layers/Pacitan_1.js"></script><script src="layers/Ponorogo_2.js"></script><script src="layers/Trenggalek_3.js"></script><script src="layers/Tulungagung_4.js"></script><script src="layers/Blitar_5.js"></script><script src="layers/KotaBlitar_6.js"></script><script src="layers/Kediri_7.js"></script><script src="layers/KotaKediri_8.js"></script><script src="layers/Malang_9.js"></script><script src="layers/KotaMalang_10.js"></script><script src="layers/Lumajang_11.js"></script><script src="layers/Jember_12.js"></script><script src="layers/Banyuwangi_13.js"></script><script src="layers/Bondowoso_14.js"></script><script src="layers/Situbondo_15.js"></script><script src="layers/Probolinggo_16.js"></script><script src="layers/KotaProbolinggo_17.js"></script><script src="layers/Pasuruan_18.js"></script><script src="layers/KotaPasuruan_19.js"></script><script src="layers/Sidoarjo_20.js"></script><script src="layers/Mojokerto_21.js"></script><script src="layers/KotaMojokerto_22.js"></script><script src="layers/Jombang_23.js"></script><script src="layers/Ngajuk_24.js"></script><script src="layers/Madiun_25.js"></script><script src="layers/KotaMadiun_26.js"></script><script src="layers/Magetan_27.js"></script><script src="layers/Ngawi_28.js"></script><script src="layers/Bojonegoro_29.js"></script><script src="layers/Tuban_30.js"></script><script src="layers/Lamongan_31.js"></script><script src="layers/Gresik_32.js"></script><script src="layers/Bangkalan_33.js"></script><script src="layers/Sampang_34.js"></script><script src="layers/Pamekasan_35.js"></script><script src="layers/Sumenep_36.js"></script><script src="layers/Surabaya_37.js"></script><script src="layers/Batu_38.js"></script><script src="layers/BatasKabupaten_39.js"></script>
  <script src="styles/Pacitan_1_style.js"></script><script src="styles/Ponorogo_2_style.js"></script><script src="styles/Trenggalek_3_style.js"></script><script src="styles/Tulungagung_4_style.js"></script><script src="styles/Blitar_5_style.js"></script><script src="styles/KotaBlitar_6_style.js"></script><script src="styles/Kediri_7_style.js"></script><script src="styles/KotaKediri_8_style.js"></script><script src="styles/Malang_9_style.js"></script><script src="styles/KotaMalang_10_style.js"></script><script src="styles/Lumajang_11_style.js"></script><script src="styles/Jember_12_style.js"></script><script src="styles/Banyuwangi_13_style.js"></script><script src="styles/Bondowoso_14_style.js"></script><script src="styles/Situbondo_15_style.js"></script><script src="styles/Probolinggo_16_style.js"></script><script src="styles/KotaProbolinggo_17_style.js"></script><script src="styles/Pasuruan_18_style.js"></script><script src="styles/KotaPasuruan_19_style.js"></script><script src="styles/Sidoarjo_20_style.js"></script><script src="styles/Mojokerto_21_style.js"></script><script src="styles/KotaMojokerto_22_style.js"></script><script src="styles/Jombang_23_style.js"></script><script src="styles/Ngajuk_24_style.js"></script><script src="styles/Madiun_25_style.js"></script><script src="styles/KotaMadiun_26_style.js"></script><script src="styles/Magetan_27_style.js"></script><script src="styles/Ngawi_28_style.js"></script><script src="styles/Bojonegoro_29_style.js"></script><script src="styles/Tuban_30_style.js"></script><script src="styles/Lamongan_31_style.js"></script><script src="styles/Gresik_32_style.js"></script><script src="styles/Bangkalan_33_style.js"></script><script src="styles/Sampang_34_style.js"></script><script src="styles/Pamekasan_35_style.js"></script><script src="styles/Sumenep_36_style.js"></script><script src="styles/Surabaya_37_style.js"></script><script src="styles/Batu_38_style.js"></script><script src="styles/BatasKabupaten_39_style.js"></script>
  <script src="./layers/layers.js" type="text/javascript"></script>
  <script src="./resources/Autolinker.min.js"></script>
  <script src="./resources/qgis2web.js"></script>
  
  <!-- ===================================================================== -->
  <!-- ==========         SKRIP KUSTOM (LOGIKA BARU & STABIL)     ========== -->
  <!-- ===================================================================== -->
  <script>
    function initializeCustomFeatures() {
        console.log("Peta siap. Memulai skrip kustom.");

        // --- 1. PENGGABUNGAN SEMUA LAYER DESA MENJADI SATU ---
        const allOriginalLayers = [
            layer_Pacitan_1, layer_Ponorogo_2, layer_Trenggalek_3, layer_Tulungagung_4, layer_Blitar_5, layer_KotaBlitar_6,
            layer_Kediri_7, layer_KotaKediri_8, layer_Malang_9, layer_KotaMalang_10, layer_Lumajang_11, layer_Jember_12,
            layer_Banyuwangi_13, layer_Bondowoso_14, layer_Situbondo_15, layer_Probolinggo_16, layer_KotaProbolinggo_17,
            layer_Pasuruan_18, layer_KotaPasuruan_19, layer_Sidoarjo_20, layer_Mojokerto_21, layer_KotaMojokerto_22,
            layer_Jombang_23, layer_Ngajuk_24, layer_Madiun_25, layer_KotaMadiun_26, layer_Magetan_27, layer_Ngawi_28,
            layer_Bojonegoro_29, layer_Tuban_30, layer_Lamongan_31, layer_Gresik_32, layer_Bangkalan_33, layer_Sampang_34,
            layer_Pamekasan_35, layer_Sumenep_36, layer_Surabaya_37, layer_Batu_38
        ];

        let allDesaFeatures = [];
        let daftarKabupaten = new Set(); // Menggunakan Set untuk menghindari duplikat

        allOriginalLayers.forEach(layer => {
            const source = layer.getSource();
            if (source) {
                const features = source.getFeatures();
                features.forEach(feature => {
                    // Simpan style asli pada setiap feature
                    feature.set('original_style', layer.getStyle());
                    allDesaFeatures.push(feature);
                    // Ambil nama kabupaten dari field WADMKK
                    const namaKab = feature.get('WADMKK');
                    if (namaKab) {
                        daftarKabupaten.add(namaKab);
                    }
                });
                // Sembunyikan layer asli setelah datanya diambil
                layer.setVisible(false);
            }
        });

        // Buat satu layer gabungan untuk semua desa
        const desaSource = new ol.source.Vector({
            features: allDesaFeatures
        });
        const desaLayer = new ol.layer.Vector({
            source: desaSource,
            style: function(feature) {
                // Gunakan style asli yang sudah kita simpan
                return feature.get('original_style');
            },
            title: 'Semua Desa' // Beri judul internal
        });
        map.addLayer(desaLayer);
        console.log(`Berhasil menggabungkan ${allDesaFeatures.length} desa menjadi satu layer.`);

        // --- 2. PENGISIAN DROPDOWN ---
        const kabSelect = document.getElementById('kabupatenSelect');
        const resetButton = document.getElementById('btnReset');
        const sortedKabupaten = Array.from(daftarKabupaten).sort();

        kabSelect.innerHTML = '<option value="">-- Semua Kabupaten --</option>';
        sortedKabupaten.forEach(nama => {
            const opt = document.createElement('option');
            opt.value = nama;
            opt.textContent = nama;
            kabSelect.appendChild(opt);
        });
        console.log(`Dropdown berhasil diisi dengan ${sortedKabupaten.length} kabupaten/kota.`);

        // --- 3. FUNGSI UNTUK MENGONTROL PETA ---
        function filterDesaByKabupaten(selectedKab) {
            // Filter features yang akan ditampilkan
            const filteredFeatures = allDesaFeatures.filter(feature => {
                return feature.get('WADMKK') === selectedKab;
            });
            // Perbarui source dengan features yang sudah difilter
            desaSource.clear();
            desaSource.addFeatures(filteredFeatures);
            // Zoom ke extent features yang difilter
            if (filteredFeatures.length > 0) {
                map.getView().fit(desaSource.getExtent(), { padding: [50, 50, 50, 50], maxZoom: 12, duration: 500 });
            }
        }
        
        function resetMapView() {
            desaSource.clear();
            desaSource.addFeatures(allDesaFeatures);
            kabSelect.value = '';
        }

        // --- 4. MEMBERI PERINTAH PADA TOMBOL DAN DROPDOWN ---
        kabSelect.addEventListener('change', function() {
            const selectedName = this.value;
            if (selectedName === '') {
                resetMapView();
            } else {
                filterDesaByKabupaten(selectedName);
            }
        });
        resetButton.addEventListener('click', resetMapView);

        // --- 5. FUNGSI HOVER DAN POPUP (SEKARANG BEKERJA DI LEVEL DESA) ---
        const popupContainer = document.getElementById('popup');
        const popupContent = document.getElementById('popup-content');
        const popupCloser = document.getElementById('popup-closer');
        const overlay = new ol.Overlay({ element: popupContainer, autoPan: true, autoPanAnimation: { duration: 250 } });
        map.addOverlay(overlay);
        popupCloser.onclick = function() { overlay.setPosition(undefined); popupCloser.blur(); return false; };

        function safeValue(value, decimalPlaces = 2) {
            if (value === null || typeof value === 'undefined' || value === '') return '-';
            if (typeof value === 'number') return value.toFixed(decimalPlaces);
            return value;
        }

        map.on('singleclick', function(evt) {
            overlay.setPosition(undefined);
            const feature = map.forEachFeatureAtPixel(evt.pixel, (f, l) => l === desaLayer ? f : null);
            if (feature) {
                const props = feature.getProperties();
                // Logika baru yang lebih jelas untuk menghitung Klaster
                const clusterFromData = props['Cluster']; // Ambil nilai mentah dari field 'Cluster'
                const clusterNumber = parseInt(clusterFromData, 10); // Coba ubah menjadi angka
                // Jika berhasil diubah menjadi angka, tambah 1. Jika tidak, tampilkan nilai aslinya.
                const displayedKlaster = !isNaN(clusterNumber) ? clusterNumber + 1 : safeValue(clusterFromData);

                const content = `
                    <strong>Nama Desa:</strong> ${safeValue(props['NAMOBJ'])}<br>
                    <strong>Kabupaten:</strong> ${safeValue(props['WADMKK'])}<br>
                    <strong>E:</strong> ${safeValue(props['E'])}<br>
                    <strong>S:</strong> ${safeValue(props['S'])}<br>
                    <strong>G:</strong> ${safeValue(props['G'])}<br>
                    <strong>ESG:</strong> ${safeValue(props['ESG'])}<br>
                    <strong>Klaster:</strong> ${displayedKlaster}`;
                popupContent.innerHTML = content;
                overlay.setPosition(evt.coordinate);
            }
        });

        let selected = null;
        const highlightStyle = new ol.style.Style({
            stroke: new ol.style.Stroke({ color: 'rgba(255, 255, 0, 1.0)', width: 3 }),
            fill: new ol.style.Fill({ color: 'rgba(255, 255, 0, 0.3)' })
        });

        map.on('pointermove', function(e) {
            if (e.dragging) return;
            if (selected !== null) {
                selected.setStyle(selected.get('original_style')); // Kembalikan ke style asli
                selected = null;
            }
            map.forEachFeatureAtPixel(e.pixel, function(f, l) {
                if (l === desaLayer) { // Hanya highlight feature dari layer desa gabungan
                    selected = f;
                    f.setStyle(highlightStyle);
                    return true;
                }
            });
            map.getTargetElement().style.cursor = selected ? 'pointer' : '';
        });
    };

    // --- MEKANISME PALING STABIL UNTUK MENUNGGU PETA SIAP ---
    const mapReadyCheck = setInterval(function() {
        if (typeof map !== 'undefined' && typeof ol !== 'undefined') {
            clearInterval(mapReadyCheck);
            initializeCustomFeatures();
        }
    }, 100);
  </script>
</body>
</html>
