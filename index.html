<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width" />
<title>Peta Kabupaten & Desa Full</title>

<link rel="stylesheet" href="./resources/ol.css" />
<link rel="stylesheet" href="resources/fontawesome-all.min.css" />
<link href="resources/photon-geocoder-autocomplete.min.css" rel="stylesheet" />
<link rel="stylesheet" href="./resources/ol-layerswitcher.css" />
<link rel="stylesheet" href="./resources/qgis2web.css" />

<style>
  html, body {
    margin: 0; padding: 0;
    width: 100vw; height: 100vh;
    font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    background-color: #fff;
  }
  #map {
    width: 100vw;
    height: 100vh;
  }
  #topbar {
    position: absolute;
    top: 10px; left: 10px;
    background: rgba(255,255,255,0.95);
    padding: 8px 12px;
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    z-index: 1100;
    font-size: 13px;
  }
  #topbar label {
    margin-right: 6px;
  }
  #topbar select, #topbar input {
    padding: 6px;
    font-size: 13px;
    margin-right: 8px;
  }
  #topbar button {
    padding: 6px 12px;
    font-size: 13px;
    cursor: pointer;
  }
  .ol-control > * {
    background-color: #f8f8f8 !important;
    color: #444 !important;
    border-radius: 0;
  }
  .ol-control > *:focus, .ol-control > *:hover {
    background-color: rgba(248, 248, 248, 0.7) !important;
  }
  .ol-control {
    background-color: rgba(255,255,255,.4) !important;
    padding: 2px !important;
  }
  .ol-popup {
    position: absolute;
    background-color: white;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    bottom: 12px;
    left: -50px;
    min-width: 200px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    font-size: 13px;
  }
  .ol-popup:after, .ol-popup:before {
    top: 100%;
    border: solid transparent;
    content: " ";
    height: 0; width: 0;
    position: absolute;
    pointer-events: none;
  }
  .ol-popup:after {
    border-top-color: white;
    border-width: 10px;
    left: 48px;
    margin-left: -10px;
  }
  .ol-popup-closer {
    text-decoration: none;
    position: absolute;
    top: 2px; right: 8px;
    font-weight: bold;
    font-size: 16px;
    color: #666;
    cursor: pointer;
  }
  .ol-popup-closer:hover {
    color: black;
  }
</style>
</head>
<body>
  <div id="topbar">
    <label for="kabupatenSelect">Pilih Kabupaten/Kota:</label>
    <select id="kabupatenSelect">
      <option value="">-- Pilih Kabupaten/Kota --</option>
    </select>

    <label for="searchDesa">Cari Desa:</label>
    <input id="searchDesa" placeholder="ketik nama desa lalu Enter" />
    <button id="btnReset">Reset</button>
  </div>

  <div id="map">
    <div id="popup" class="ol-popup" style="display:none;">
      <a href="#" id="popup-closer" class="ol-popup-closer">&#10005;</a>
      <div id="popup-content"></div>
    </div>
  </div>

  <!-- LIBRARIES -->
  <script src="./resources/ol.js"></script>
  <script src="./resources/ol-layerswitcher.js"></script>
  <script src="resources/photon-geocoder-autocomplete.min.js"></script>

  <!-- LAYERS (masukkan semua layer kabupaten dan kota di sini) -->
  <script src="layers/Pacitan_1.js"></script>
  <script src="layers/Ponorogo_2.js"></script>
  <script src="layers/Trenggalek_3.js"></script>
  <script src="layers/Tulungagung_4.js"></script>
  <script src="layers/Blitar_5.js"></script>
  <script src="layers/KotaBlitar_6.js"></script>
  <script src="layers/Kediri_7.js"></script>
  <script src="layers/KotaKediri_8.js"></script>
  <script src="layers/Malang_9.js"></script>
  <script src="layers/KotaMalang_10.js"></script>
  <script src="layers/Lumajang_11.js"></script>
  <script src="layers/Jember_12.js"></script>
  <script src="layers/Banyuwangi_13.js"></script>
  <script src="layers/Bondowoso_14.js"></script>
  <script src="layers/Situbondo_15.js"></script>
  <script src="layers/Probolinggo_16.js"></script>
  <script src="layers/KotaProbolinggo_17.js"></script>
  <script src="layers/Pasuruan_18.js"></script>
  <script src="layers/KotaPasuruan_19.js"></script>
  <script src="layers/Sidoarjo_20.js"></script>
  <script src="layers/Mojokerto_21.js"></script>
  <script src="layers/KotaMojokerto_22.js"></script>
  <script src="layers/Jombang_23.js"></script>
  <script src="layers/Ngajuk_24.js"></script>
  <script src="layers/Madiun_25.js"></script>
  <script src="layers/KotaMadiun_26.js"></script>
  <script src="layers/Magetan_27.js"></script>
  <script src="layers/Ngawi_28.js"></script>
  <script src="layers/Bojonegoro_29.js"></script>
  <script src="layers/Tuban_30.js"></script>
  <script src="layers/Lamongan_31.js"></script>
  <script src="layers/Gresik_32.js"></script>
  <script src="layers/Bangkalan_33.js"></script>
  <script src="layers/Sampang_34.js"></script>
  <script src="layers/Pamekasan_35.js"></script>
  <script src="layers/Sumenep_36.js"></script>
  <script src="layers/Surabaya_37.js"></script>
  <script src="layers/Batu_38.js"></script>
  <script src="layers/BatasKabupaten_39.js"></script>

  <!-- STYLES -->
  <script src="styles/Pacitan_1_style.js"></script>
  <script src="styles/Ponorogo_2_style.js"></script>
  <script src="styles/Trenggalek_3_style.js"></script>
  <script src="styles/Tulungagung_4_style.js"></script>
  <script src="styles/Blitar_5_style.js"></script>
  <script src="styles/KotaBlitar_6_style.js"></script>
  <script src="styles/Kediri_7_style.js"></script>
  <script src="styles/KotaKediri_8_style.js"></script>
  <script src="styles/Malang_9_style.js"></script>
  <script src="styles/KotaMalang_10_style.js"></script>
  <script src="styles/Lumajang_11_style.js"></script>
  <script src="styles/Jember_12_style.js"></script>
  <script src="styles/Banyuwangi_13_style.js"></script>
  <script src="styles/Bondowoso_14_style.js"></script>
  <script src="styles/Situbondo_15_style.js"></script>
  <script src="styles/Probolinggo_16_style.js"></script>
  <script src="styles/KotaProbolinggo_17_style.js"></script>
  <script src="styles/Pasuruan_18_style.js"></script>
  <script src="styles/KotaPasuruan_19_style.js"></script>
  <script src="styles/Sidoarjo_20_style.js"></script>
  <script src="styles/Mojokerto_21_style.js"></script>
  <script src="styles/KotaMojokerto_22_style.js"></script>
  <script src="styles/Jombang_23_style.js"></script>
  <script src="styles/Ngajuk_24_style.js"></script>
  <script src="styles/Madiun_25_style.js"></script>
  <script src="styles/KotaMadiun_26_style.js"></script>
  <script src="styles/Magetan_27_style.js"></script>
  <script src="styles/Ngawi_28_style.js"></script>
  <script src="styles/Bojonegoro_29_style.js"></script>
  <script src="styles/Tuban_30_style.js"></script>
  <script src="styles/Lamongan_31_style.js"></script>
  <script src="styles/Gresik_32_style.js"></script>
  <script src="styles/Bangkalan_33_style.js"></script>
  <script src="styles/Sampang_34_style.js"></script>
  <script src="styles/Pamekasan_35_style.js"></script>
  <script src="styles/Sumenep_36_style.js"></script>
  <script src="styles/Surabaya_37_style.js"></script>
  <script src="styles/Batu_38_style.js"></script>
  <script src="styles/BatasKabupaten_39_style.js"></script>

<script>
(function() {
  // Utility to wait until map and layersList are ready
  function waitFor(conditionFn, interval = 100, timeout = 10000) {
    const start = Date.now();
    return new Promise((resolve) => {
      (function poll() {
        try {
          if (conditionFn()) return resolve(true);
        } catch(e) {}
        if (Date.now() - start > timeout) return resolve(false);
        setTimeout(poll, interval);
      })();
    });
  }

  function safeText(v) {
    return (v === undefined || v === null || v === '') ? '-' : String(v);
  }

  waitFor(() => typeof window.map !== 'undefined' && Array.isArray(window.layersList), 100, 10000)
  .then(ok => {
    if (!ok) {
      alert('âŒ map atau layersList tidak tersedia, cek console untuk error.');
      return;
    }

    const kabSelect = document.getElementById('kabupatenSelect');
    const searchDesa = document.getElementById('searchDesa');
    const btnReset = document.getElementById('btnReset');
    const popupEl = document.getElementById('popup');
    const popupCloser = document.getElementById('popup-closer');
    const popupContent = document.getElementById('popup-content');

    // Definisikan array kabupaten/kota dengan index layer sesuai layersList
    const kabupatenLayers = [
      { title: 'Pacitan', idx: 0 },
      { title: 'Ponorogo', idx: 1 },
      { title: 'Trenggalek', idx: 2 },
      { title: 'Tulungagung', idx: 3 },
      { title: 'Blitar', idx: 4 },
      { title: 'Kota Blitar', idx: 5 },
      { title: 'Kediri', idx: 6 },
      { title: 'Kota Kediri', idx: 7 },
      { title: 'Malang', idx: 8 },
      { title: 'Kota Malang', idx: 9 },
      { title: 'Lumajang', idx: 10 },
      { title: 'Jember', idx: 11 },
      { title: 'Banyuwangi', idx: 12 },
      { title: 'Bondowoso', idx: 13 },
      { title: 'Situbondo', idx: 14 },
      { title: 'Probolinggo', idx: 15 },
      { title: 'Kota Probolinggo', idx: 16 },
      { title: 'Pasuruan', idx: 17 },
      { title: 'Kota Pasuruan', idx: 18 },
      { title: 'Sidoarjo', idx: 19 },
      { title: 'Mojokerto', idx: 20 },
      { title: 'Kota Mojokerto', idx: 21 },
      { title: 'Jombang', idx: 22 },
      { title: 'Ngajuk', idx: 23 },
      { title: 'Madiun', idx: 24 },
      { title: 'Kota Madiun', idx: 25 },
      { title: 'Magetan', idx: 26 },
      { title: 'Ngawi', idx: 27 },
      { title: 'Bojonegoro', idx: 28 },
      { title: 'Tuban', idx: 29 },
      { title: 'Lamongan', idx: 30 },
      { title: 'Gresik', idx: 31 },
      { title: 'Bangkalan', idx: 32 },
      { title: 'Sampang', idx: 33 },
      { title: 'Pamekasan', idx: 34 },
      { title: 'Sumenep', idx: 35 },
      { title: 'Surabaya', idx: 36 },
      { title: 'Batu', idx: 37 },
    ];

    // Layer batas kabupaten selalu di layer terakhir (index 39)
    const batasKabupatenIdx = 39;
    const batasKabupatenLayer = layersList[batasKabupatenIdx];
    if (batasKabupatenLayer) {
      batasKabupatenLayer.setVisible(true);
      batasKabupatenLayer.setOpacity(1);
      // set Z-index supaya selalu di atas
      batasKabupatenLayer.setZIndex(999);
    }

    // Set semua layer kabupaten visible dan opacity 1
    kabupatenLayers.forEach(({idx})=>{
      const lyr = layersList[idx];
      if(lyr){
        lyr.setVisible(true);
        lyr.setOpacity(1);
        lyr.setZIndex(10); // di bawah batas kabupaten
      }
    });

    // Isi dropdown kabupaten
    kabSelect.innerHTML = '<option value="">-- Pilih Kabupaten/Kota --</option>';
    kabupatenLayers.forEach(({title, idx})=>{
      const option = document.createElement('option');
      option.value = idx;
      option.textContent = title;
      kabSelect.appendChild(option);
    });

    // Hover interaction
    let hoverSelect = null;
    function enableHoverForLayer(layer) {
      if(hoverSelect){
        map.removeInteraction(hoverSelect);
        hoverSelect = null;
      }
      if(!layer) return;
      hoverSelect = new ol.interaction.Select({
        condition: ol.events.condition.pointerMove,
        layers: [layer],
        style: new ol.style.Style({
          stroke: new ol.style.Stroke({color:'yellow', width:3}),
          fill: new ol.style.Fill({color:'rgba(255,255,0,0.25)'}),
        }),
      });
      map.addInteraction(hoverSelect);
    }

    // Fungsi reset ke default (semua layer visible opacity 1, zoom ke seluruh kabupaten)
    function resetMapView(){
      kabupatenLayers.forEach(({idx})=>{
        const lyr = layersList[idx];
        if(lyr){
          lyr.setOpacity(1);
          lyr.setVisible(true);
        }
      });
      if(batasKabupatenLayer){
        batasKabupatenLayer.setVisible(true);
        batasKabupatenLayer.setOpacity(1);
      }
      // Zoom ke gabungan extent seluruh kabupaten
      let extentAll = ol.extent.createEmpty();
      kabupatenLayers.forEach(({idx})=>{
        const lyr = layersList[idx];
        if(lyr){
          try{
            const src = lyr.getSource();
            if(src && src.getExtent){
              ol.extent.extend(extentAll, src.getExtent());
            }
          }catch(e){}
        }
      });
      if(!ol.extent.isEmpty(extentAll)){
        map.getView().fit(extentAll, {padding:[40,40,40,40], maxZoom: 11, duration: 700});
      }

      // Hapus popup
      overlay.setPosition(undefined);
      popupEl.style.display = 'none';

      // Hapus pilihan dropdown
      kabSelect.value = "";
      // Disable hover (no specific layer focused)
      if(hoverSelect){
        map.removeInteraction(hoverSelect);
        hoverSelect = null;
      }
    }

    // Popup overlay
    const overlay = new ol.Overlay({
      element: popupEl,
      autoPan: {animation: {duration: 250}},
    });
    map.addOverlay(overlay);

    popupCloser.onclick = function(){
      overlay.setPosition(undefined);
      popupEl.style.display = 'none';
      popupCloser.blur();
      return false;
    };

    // Klik fitur untuk popup hanya di layer yang fokus (opacity 1)
    map.on('singleclick', function(evt){
      // cari layer dengan opacity 1 dan visible
      let activeLayer = null;
      for(let {idx} of kabupatenLayers){
        const lyr = layersList[idx];
        if(lyr && lyr.getVisible() && lyr.getOpacity() === 1){
          activeLayer = lyr;
          break;
        }
      }
      if(!activeLayer) return;

      let feature = map.forEachFeatureAtPixel(evt.pixel, function(feature, layer){
        if(layer === activeLayer) return feature;
      });
      if(feature){
        const props = feature.getProperties();
        let info = '<b>Info Desa/Kecamatan</b><br>';
        for(let key in props){
          if(key !== 'geometry'){
            info += `<b>${key}</b>: ${safeText(props[key])}<br>`;
          }
        }
        popupContent.innerHTML = info;
        popupEl.style.display = 'block';
        overlay.setPosition(evt.coordinate);
      } else {
        overlay.setPosition(undefined);
        popupEl.style.display = 'none';
      }
    });

    // Saat pilih kabupaten, fokus ke kabupaten tsb
    kabSelect.onchange = function(){
      const idx = parseInt(this.value);
      if(isNaN(idx)){
        resetMapView();
        return;
      }
      // set opacity kabupaten yg dipilih 1, yg lain 0.3
      kabupatenLayers.forEach(({idx: lid})=>{
        const lyr = layersList[lid];
        if(lyr){
          lyr.setOpacity(lid === idx ? 1 : 0.3);
          lyr.setVisible(true);
        }
      });
      // Batas kabupaten tetap opacity 1
      if(batasKabupatenLayer){
        batasKabupatenLayer.setVisible(true);
        batasKabupatenLayer.setOpacity(1);
      }

      // Zoom ke extent kabupaten yang dipilih
      const lyr = layersList[idx];
      if(lyr){
        try {
          const src = lyr.getSource();
          const extent = src.getExtent();
          if(extent){
            map.getView().fit(extent, {padding:[40,40,40,40], maxZoom: 12, duration: 700});
          }
        } catch(e){}
      }
      // Set hover hanya ke kabupaten terpilih
      enableHoverForLayer(layersList[idx]);

      // Clear popup
      overlay.setPosition(undefined);
      popupEl.style.display = 'none';
    };

    // Fungsi cari desa di layer kabupaten terpilih (opacity 1)
    function searchDesaOnLayer(layer, query){
      if(!layer || !query) return;
      const source = layer.getSource();
      if(!source) return;

      let foundFeature = null;
      source.forEachFeature(function(feature){
        if(foundFeature) return;
        const props = feature.getProperties();
        for(const key in props){
          if(key.toLowerCase().includes('nama') && typeof props[key] === 'string'){
            if(props[key].toLowerCase().includes(query.toLowerCase())){
              foundFeature = feature;
              break;
            }
          }
        }
      });

      if(foundFeature){
        const geom = foundFeature.getGeometry();
        const coord = geom.getClosestPoint(map.getView().getCenter());
        map.getView().animate({center: coord, zoom: 14, duration: 700});
        // Tampilkan popup desa
        let info = '<b>Desa ditemukan:</b><br>';
        const props = foundFeature.getProperties();
        for(let key in props){
          if(key !== 'geometry'){
            info += `<b>${key}</b>: ${safeText(props[key])}<br>`;
          }
        }
        popupContent.innerHTML = info;
        popupEl.style.display = 'block';
        overlay.setPosition(coord);
      } else {
        alert('Desa tidak ditemukan pada kabupaten terpilih.');
      }
    }

    // Event search desa enter
    searchDesa.addEventListener('keydown', function(evt){
      if(evt.key === 'Enter'){
        evt.preventDefault();
        const val = searchDesa.value.trim();
        if(!val){
          alert('Masukkan nama desa untuk mencari.');
          return;
        }
        // Cari layer yang opacity 1 (kabupaten terpilih)
        let activeLayer = null;
        for(let {idx} of kabupatenLayers){
          const lyr = layersList[idx];
          if(lyr && lyr.getVisible() && lyr.getOpacity() === 1){
            activeLayer = lyr;
            break;
          }
        }
        if(!activeLayer){
          alert('Pilih kabupaten/kota terlebih dahulu untuk mencari desa.');
          return;
        }
        searchDesaOnLayer(activeLayer, val);
      }
    });

    // Tombol Reset
    btnReset.onclick = function(){
      resetMapView();
      searchDesa.value = '';
    };

    // Inisialisasi view - zoom ke seluruh kabupaten (gabungan extent)
    resetMapView();

  });
})();
</script>

</body>
</html>
