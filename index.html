<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>Peta Kabupaten & Desa (Full)</title>

  <!-- CSS -->
  <link rel="stylesheet" href="./resources/ol.css">
  <link rel="stylesheet" href="./resources/qgis2web.css">
  <link rel="stylesheet" href="./resources/ol-layerswitcher.css">

  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { width: 100%; height: 100vh; }
    .controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 1000;
      background: rgba(255,255,255,0.95);
      padding: 8px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    }
    .controls label { margin-right:6px; font-size:13px; }
    .controls select, .controls input {
      padding:6px 8px;
      font-size:13px;
      margin-right:8px;
    }
    /* Popup styling (preserve qgis2web look) */
    .ol-popup {
      position: absolute;
      background-color: white;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      min-width: 260px;
    }
    .ol-popup-closer { position:absolute; top:6px; right:8px; text-decoration:none; font-weight:bold; }
  </style>
</head>
<body>

  <!-- Controls: dropdown kabupaten (per-layer) + search desa -->
  <div class="controls">
    <label for="kabSelect">Kabupaten:</label>
    <select id="kabSelect"></select>

    <label for="desaSearch">Cari Desa:</label>
    <input id="desaSearch" placeholder="ketik nama desa lalu Enter" />
    <button id="btnClear">Reset View</button>
  </div>

  <div id="map"></div>

  <!-- Popup -->
  <div id="popup" class="ol-popup" style="display:none;">
    <a href="#" id="popup-closer" class="ol-popup-closer">×</a>
    <div id="popup-content"></div>
  </div>

  <!-- Dependencies & qgis2web outputs -->
  <!-- NOTE: urutan penting: ekspresi (jika ada) + OL + layer files + styles + layers.js + qgis2web.js -->
  <script src="./resources/qgis2web_expressions.js"></script>
  <script src="./resources/functions.js"></script>
  <script src="./resources/ol.js"></script>
  <script src="./resources/ol-layerswitcher.js"></script>

  <!-- Semua layer (urut sesuai layers.js yang kamu punya) -->
  <script src="./layers/GoogleSatellite_0.js"></script>
  <script src="./layers/Pacitan_1.js"></script>
  <script src="./layers/Ponorogo_2.js"></script>
  <script src="./layers/Trenggalek_3.js"></script>
  <script src="./layers/Tulungagung_4.js"></script>
  <script src="./layers/Blitar_5.js"></script>
  <script src="./layers/KotaBlitar_6.js"></script>
  <script src="./layers/Kediri_7.js"></script>
  <script src="./layers/KotaKediri_8.js"></script>
  <script src="./layers/Malang_9.js"></script>
  <script src="./layers/KotaMalang_10.js"></script>
  <script src="./layers/Lumajang_11.js"></script>
  <script src="./layers/Jember_12.js"></script>
  <script src="./layers/Banyuwangi_13.js"></script>
  <script src="./layers/Bondowoso_14.js"></script>
  <script src="./layers/Situbondo_15.js"></script>
  <script src="./layers/Probolinggo_16.js"></script>
  <script src="./layers/KotaProbolinggo_17.js"></script>
  <script src="./layers/Pasuruan_18.js"></script>
  <script src="./layers/KotaPasuruan_19.js"></script>
  <script src="./layers/Sidoarjo_20.js"></script>
  <script src="./layers/Mojokerto_21.js"></script>
  <script src="./layers/KotaMojokerto_22.js"></script>
  <script src="./layers/Jombang_23.js"></script>
  <script src="./layers/Ngajuk_24.js"></script>
  <script src="./layers/Madiun_25.js"></script>
  <script src="./layers/KotaMadiun_26.js"></script>
  <script src="./layers/Magetan_27.js"></script>
  <script src="./layers/Ngawi_28.js"></script>
  <script src="./layers/Bojonegoro_29.js"></script>
  <script src="./layers/Tuban_30.js"></script>
  <script src="./layers/Lamongan_31.js"></script>
  <script src="./layers/Gresik_32.js"></script>
  <script src="./layers/Bangkalan_33.js"></script>
  <script src="./layers/Sampang_34.js"></script>
  <script src="./layers/Pamekasan_35.js"></script>
  <script src="./layers/Sumenep_36.js"></script>
  <script src="./layers/Surabaya_37.js"></script>
  <script src="./layers/Batu_38.js"></script>
  <script src="./layers/BatasKabupaten_39.js"></script>

  <!-- Semua style file (hasil export qgis2web; pastikan folder 'styles' ada dan berisi file-file ini) -->
  <script src="./styles/style_Pacitan_1.js"></script>
  <script src="./styles/style_Ponorogo_2.js"></script>
  <script src="./styles/style_Trenggalek_3.js"></script>
  <script src="./styles/style_Tulungagung_4.js"></script>
  <script src="./styles/style_Blitar_5.js"></script>
  <script src="./styles/style_KotaBlitar_6.js"></script>
  <script src="./styles/style_Kediri_7.js"></script>
  <script src="./styles/style_KotaKediri_8.js"></script>
  <script src="./styles/style_Malang_9.js"></script>
  <script src="./styles/style_KotaMalang_10.js"></script>
  <script src="./styles/style_Lumajang_11.js"></script>
  <script src="./styles/style_Jember_12.js"></script>
  <script src="./styles/style_Banyuwangi_13.js"></script>
  <script src="./styles/style_Bondowoso_14.js"></script>
  <script src="./styles/style_Situbondo_15.js"></script>
  <script src="./styles/style_Probolinggo_16.js"></script>
  <script src="./styles/style_KotaProbolinggo_17.js"></script>
  <script src="./styles/style_Pasuruan_18.js"></script>
  <script src="./styles/style_KotaPasuruan_19.js"></script>
  <script src="./styles/style_Sidoarjo_20.js"></script>
  <script src="./styles/style_Mojokerto_21.js"></script>
  <script src="./styles/style_KotaMojokerto_22.js"></script>
  <script src="./styles/style_Jombang_23.js"></script>
  <script src="./styles/style_Ngajuk_24.js"></script>
  <script src="./styles/style_Madiun_25.js"></script>
  <script src="./styles/style_KotaMadiun_26.js"></script>
  <script src="./styles/style_Magetan_27.js"></script>
  <script src="./styles/style_Ngawi_28.js"></script>
  <script src="./styles/style_Bojonegoro_29.js"></script>
  <script src="./styles/style_Tuban_30.js"></script>
  <script src="./styles/style_Lamongan_31.js"></script>
  <script src="./styles/style_Gresik_32.js"></script>
  <script src="./styles/style_Bangkalan_33.js"></script>
  <script src="./styles/style_Sampang_34.js"></script>
  <script src="./styles/style_Pamekasan_35.js"></script>
  <script src="./styles/style_Sumenep_36.js"></script>
  <script src="./styles/style_Surabaya_37.js"></script>
  <script src="./styles/style_Batu_38.js"></script>
  <script src="./styles/style_BatasKabupaten_39.js"></script>

  <!-- layers.js (harus setelah semua layer & style ter-load) -->
  <script src="./layers/layers.js"></script>

  <!-- qgis2web main -->
  <script src="./resources/qgis2web.js"></script>

  <!-- Custom logic: dropdown per-layer kabupaten, search desa, hover, popup -->
  <script>
    (function () {
      // Tunggu sampai map & layersList dibuat oleh qgis2web.js
      function waitForMap(maxWait = 8000) {
        return new Promise((resolve) => {
          const start = Date.now();
          (function poll() {
            if (typeof window.map !== 'undefined' && Array.isArray(window.layersList)) {
              return resolve(true);
            }
            if (Date.now() - start > maxWait) return resolve(false);
            setTimeout(poll, 100);
          })();
        });
      }

      function safeText(v) { return (v === undefined || v === null || v === '') ? '-' : String(v); }

      waitForMap(10000).then((ok) => {
        if (!ok) {
          console.error("map or layersList not found. Check console for 404s or script errors.");
          alert("❌ map/layersList tidak ditemukan. Pastikan semua file qgis2web ter-load (cek Network/Console).");
          return;
        }

        // Ambil elemen UI
        const kabSelect = document.getElementById('kabSelect');
        const desaSearch = document.getElementById('desaSearch');
        const btnClear = document.getElementById('btnClear');
        const popupEl = document.getElementById('popup');
        const popupCloser = document.getElementById('popup-closer');
        const popupContent = document.getElementById('popup-content');

        // Isi dropdown dari layersList — hanya layer yang bertipe Vector dan bukan layer 'BatasKabupaten' / bukan base
        const candidateLayers = [];
        layersList.forEach((lyr, idx) => {
          try {
            const title = lyr.get('title') || lyr.get('name') || ('layer_' + idx);
            // Kita asumsikan layer kabupaten punya kata tidak 'Google' dan bukan boundary group
            const isVector = (lyr instanceof ol.layer.Vector);
            if (isVector && title && !/Google|Base|Raster|Batas/i.test(title)) {
              candidateLayers.push({ layer: lyr, title: title, index: idx });
            }
          } catch (e) {
            // ignore
          }
        });

        if (candidateLayers.length === 0) {
          // Jika tidak ketemu vector di layersList, fallback ke map.getLayers()
          map.getLayers().forEach((lyr, idx) => {
            if (lyr instanceof ol.layer.Vector) {
              candidateLayers.push({ layer: lyr, title: lyr.get('title') || ('layer_'+idx), index: idx });
            }
          });
        }

        // jika masih kosong beri peringatan
        if (candidateLayers.length === 0) {
          console.warn("Tidak ditemukan candidate layer kabupaten (vector). Semua layer akan dianggap ada, tapi dropdown kosong.");
        }

        // Isi dropdown
        candidateLayers.forEach((item, i) => {
          const opt = document.createElement('option');
          opt.value = item.index;
          opt.textContent = item.title;
          kabSelect.appendChild(opt);
        });

        // Default: nonaktifkan semua candidate, aktifkan yang pertama (jika ada)
        candidateLayers.forEach((item, i) => item.layer.setVisible(false));
        if (candidateLayers.length > 0) {
          candidateLayers[0].layer.setVisible(true);
          kabSelect.value = candidateLayers[0].index;
        }

        // Layer switcher kontrol (agar user bisa lihat/atur layer lainnya)
        const layerSwitcher = new ol.control.LayerSwitcher({
          tipLabel: 'Daftar layer',
          groupSelectStyle: 'children',
        });
        map.addControl(layerSwitcher);
        // force open panel if API supports
        if (layerSwitcher && layerSwitcher.showPanel) {
          setTimeout(() => layerSwitcher.showPanel(), 300);
        }

        // Hover via Select interaction: hanya target layer aktif (update saat ganti kabupaten)
        let selectHover = null;
        function resetHoverInteraction() {
          if (selectHover) {
            map.removeInteraction(selectHover);
            selectHover = null;
          }
          // buat interaction baru yang hanya menargetkan current candidate layer
          const activeLayer = candidateLayers.find(c => c.layer.getVisible());
          if (!activeLayer) return;
          selectHover = new ol.interaction.Select({
            condition: ol.events.condition.pointerMove,
            style: new ol.style.Style({
              stroke: new ol.style.Stroke({ color: '#ffff00', width: 2 }),
              fill: new ol.style.Fill({ color: 'rgba(255,255,0,0.25)' })
            }),
            layers: [ activeLayer.layer ]
          });
          map.addInteraction(selectHover);
        }

        // Popup overlay
        const overlay = new ol.Overlay({
          element: popupEl,
          autoPan: { animation: { duration: 250 } }
        });
        map.addOverlay(overlay);
        popupCloser.onclick = function () { overlay.setPosition(undefined); popupEl.style.display = 'none'; popupCloser.blur(); return false; };

        // Click: hanya tampilkan fitur dari layer yang visible (active kabupaten)
        map.on('singleclick', function(evt) {
          // prioritas: check features only on visible candidate layer
          let clickedFeature = null;
          let clickedLayer = null;
          map.forEachFeatureAtPixel(evt.pixel, function(feature, layer) {
            if (!feature) return null;
            // only from the active candidate layer
            const isActiveCandidate = candidateLayers.some(c => c.layer === layer && layer.getVisible());
            if (isActiveCandidate) {
              clickedFeature = feature;
              clickedLayer = layer;
              return feature;
            }
          }, { hitTolerance: 6 });

          if (clickedFeature) {
            // tampilkan popup dengan atribut (kecuali geometry)
            const props = clickedFeature.getProperties ? clickedFeature.getProperties() : {};
            let html = '<div style="font-size:14px;"><strong>' + (clickedLayer.get('title') || '') + '</strong><hr style="margin:6px 0;" />';
            html += '<table style="font-size:13px;">';
            Object.keys(props).forEach(k => {
              if (k === 'geometry') return;
              html += '<tr><td style="font-weight:600;padding-right:8px;">' + k + '</td><td>' + safeText(props[k]) + '</td></tr>';
            });
            html += '</table></div>';
            popupContent.innerHTML = html;
            popupEl.style.display = 'block';
            overlay.setPosition(evt.coordinate);
          } else {
            overlay.setPosition(undefined);
          }
        });

        // Search desa: tekan Enter di input = cari di layer aktif (field default: WADMKD)
        desaSearch.addEventListener('keydown', function(e) {
          if (e.key !== 'Enter') return;
          const q = this.value.trim().toLowerCase();
          if (!q) return;
          const active = candidateLayers.find(c => c.layer.getVisible());
          if (!active) { alert('Pilih kabupaten dahulu.'); return; }
          const src = active.layer.getSource();
          const features = src.getFeatures ? src.getFeatures() : [];
          let found = null;
          for (let f of features) {
            const val = (f.get && (f.get('WADMKD') || f.get('WADMKD'.toUpperCase()))) || f.get && f.get('WADMKD');
            const name = (val || '').toString().toLowerCase();
            if (name.indexOf(q) !== -1) { found = f; break; }
          }
          if (found) {
            const geom = found.getGeometry();
            if (geom) {
              const ext = geom.getExtent();
              map.getView().fit(ext, { padding: [40,40,40,40], maxZoom: 16, duration: 600 });
              // show popup centered on feature
              const center = ol.extent.getCenter(ext);
              popupContent.innerHTML = '<div style="font-weight:600">' + safeText(found.get('WADMKD') || found.get('WADMKC') || '') + '</div>';
              popupEl.style.display = 'block';
              overlay.setPosition(center);
            }
          } else {
            alert('Desa tidak ditemukan dalam layer kabupaten aktif.');
          }
        });

        // Change kabupaten dropdown: set only selected layer visible
        kabSelect.addEventListener('change', function() {
          const idx = parseInt(this.value);
          candidateLayers.forEach(c => {
            const visible = (c.index === idx);
            c.layer.setVisible(visible);
          });
          // re-init hover interaction for active layer
          resetHoverInteraction();
          // close popup when switching
          overlay.setPosition(undefined);
        });

        // Reset view: show all layers off and close popup, then zoom to default
        btnClear.addEventListener('click', function() {
          candidateLayers.forEach((c, i) => c.layer.setVisible(false));
          // show base or boundary layer if exists
          map.getView().setCenter(map.getView().getCenter()); // no-op but keeps view
          overlay.setPosition(undefined);
        });

        // Initialize hover interaction for first visible candidate
        resetHoverInteraction();

        console.log('Inisialisasi selesai. candidateLayers:', candidateLayers.map(c => c.title));
      }); // end waitForMap
    })();
  </script>
</body>
</html>
