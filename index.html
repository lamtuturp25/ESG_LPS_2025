<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Peta ESG Interaktif</title>
<link rel="stylesheet" href="./resources/ol.css">
<link rel="stylesheet" href="./resources/qgis2web.css">
<link rel="stylesheet" href="./resources/ol-layerswitcher.css">
<style>
html, body { margin:0; padding:0; height:100%; }
#map { width: 100%; height: 100vh; }

/* Dropdown filter */
#controls {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(255,255,255,0.9);
    padding: 8px;
    border-radius: 4px;
    font-family: sans-serif;
    z-index: 1000;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

/* Popup */
.ol-popup {
    position: absolute;
    background-color: white;
    padding: 10px;
    border: 1px solid #cccccc;
    border-radius: 4px;
    min-width: 200px;
    bottom: 12px;
    left: -50px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}
.ol-popup:after, .ol-popup:before {
    top: 100%;
    border: solid transparent;
    content: " ";
    height: 0;
    width: 0;
    position: absolute;
    pointer-events: none;
}
.ol-popup:after {
    border-top-color: white;
    border-width: 10px;
    left: 48px;
    margin-left: -10px;
}
.ol-popup:before {
    border-top-color: #cccccc;
    border-width: 11px;
    left: 48px;
    margin-left: -11px;
}
.ol-popup-closer {
    text-decoration: none;
    position: absolute;
    top: 2px;
    right: 8px;
}

/* Hover Style */
.hover-feature {
    stroke: #ffff00;
    stroke-width: 2;
    fill: rgba(255,255,0,0.3);
}
</style>
</head>
<body>

<!-- Dropdown Filter -->
<div id="controls">
    <label>Kabupaten:</label>
    <select id="kabupatenFilter">
        <option value="">Semua</option>
    </select>
    <label>Kecamatan:</label>
    <select id="kecamatanFilter">
        <option value="">Semua</option>
    </select>
</div>

<div id="map"></div>

<!-- Popup -->
<div id="popup" class="ol-popup">
    <a href="#" id="popup-closer" class="ol-popup-closer">✖</a>
    <div id="popup-content"></div>
</div>

<!-- QGIS2Web & Dependencies -->
<script src="./resources/qgis2web_expressions.js"></script>
<script src="./resources/ol.js"></script>
<script src="./resources/ol-layerswitcher.js"></script>
<script src="layers/Pacitan_1.js"></script>
<script src="layers/Ponorogo_2.js"></script>
<!-- ... semua layer hasil export ... -->
<script src="layers/Batu_38.js"></script>
<script src="layers/BatasKabupaten_39.js"></script>
<script src="styles.js"></script>
<script src="layers/layers.js"></script>
<script src="./resources/Autolinker.min.js"></script>
<script src="qgis2web.js"></script>

<script>
window.addEventListener("load", function() {
    if (typeof map === "undefined" || typeof layersList === "undefined") {
        alert("❌ map/layersList tidak ditemukan. Pastikan urutan file benar.");
        return;
    }

    // === Popup Setup ===
    const container = document.getElementById('popup');
    const content = document.getElementById('popup-content');
    const closer = document.getElementById('popup-closer');

    const overlay = new ol.Overlay({
        element: container,
        autoPan: { animation: { duration: 250 } }
    });
    map.addOverlay(overlay);

    closer.onclick = function() {
        overlay.setPosition(undefined);
        closer.blur();
        return false;
    };

    // === Ambil semua layer vector ===
    function getVectorLayers() {
        const vectorLayers = [];
        map.getLayers().forEach(function(layer) {
            if (layer instanceof ol.layer.Vector) {
                vectorLayers.push(layer);
            } else if (layer instanceof ol.layer.Group) {
                layer.getLayers().forEach(function(sublayer) {
                    if (sublayer instanceof ol.layer.Vector) {
                        vectorLayers.push(sublayer);
                    }
                });
            }
        });
        return vectorLayers;
    }
    const vectorLayers = getVectorLayers();

    // === Hover ===
    const hoverStyle = new ol.style.Style({
        stroke: new ol.style.Stroke({ color: '#ffff00', width: 2 }),
        fill: new ol.style.Fill({ color: 'rgba(255,255,0,0.3)' })
    });
    let highlight;
    map.on('pointermove', function(evt) {
        if (highlight) {
            highlight.setStyle(undefined);
            highlight = null;
        }
        map.forEachFeatureAtPixel(evt.pixel, function(feature, layer) {
            if (layer.getVisible()) {
                highlight = feature;
                feature.setStyle(hoverStyle);
            }
        });
    });

    // === Popup on Click ===
    map.on('singleclick', function(evt) {
        const feature = map.forEachFeatureAtPixel(evt.pixel, function(feat, layer) {
            if (layer.getVisible()) {
                return feat;
            }
        });
        if (feature) {
            const props = feature.getProperties();
            let html = "<table>";
            for (let key in props) {
                if (key !== "geometry") {
                    html += `<tr><th>${key}</th><td>${props[key]}</td></tr>`;
                }
            }
            html += "</table>";
            content.innerHTML = html;
            overlay.setPosition(evt.coordinate);
        } else {
            overlay.setPosition(undefined);
        }
    });

    // === Layer Switcher ===
    const layerSwitcher = new ol.control.LayerSwitcher({
        tipLabel: 'Daftar Layer',
        activationMode: 'click',
        startActive: true
    });
    map.addControl(layerSwitcher);

    // === Dropdown Filter Setup ===
    const kabupatenSelect = document.getElementById('kabupatenFilter');
    const kecamatanSelect = document.getElementById('kecamatanFilter');

    // Ambil semua nilai kabupaten & kecamatan unik dari layer
    const kabSet = new Set();
    const kecSet = new Set();
    vectorLayers.forEach(layer => {
        layer.getSource().forEachFeature(feature => {
            const kab = feature.get('WADMKK');
            const kec = feature.get('WADMKC');
            if (kab) kabSet.add(kab);
            if (kec) kecSet.add(kec);
        });
    });

    kabSet.forEach(kab => {
        const opt = document.createElement('option');
        opt.value = kab;
        opt.textContent = kab;
        kabupatenSelect.appendChild(opt);
    });
    kecSet.forEach(kec => {
        const opt = document.createElement('option');
        opt.value = kec;
        opt.textContent = kec;
        kecamatanSelect.appendChild(opt);
    });

    // === Filter function ===
    function applyFilter() {
        const kabVal = kabupatenSelect.value;
        const kecVal = kecamatanSelect.value;
        vectorLayers.forEach(layer => {
            layer.getSource().forEachFeature(feature => {
                const matchKab = !kabVal || feature.get('WADMKK') === kabVal;
                const matchKec = !kecVal || feature.get('WADMKC') === kecVal;
                feature.setStyle(matchKab && matchKec ? undefined : new ol.style.Style({}));
            });
        });
    }
    kabupatenSelect.addEventListener('change', applyFilter);
    kecamatanSelect.addEventListener('change', applyFilter);
});
</script>
</body>
</html>
