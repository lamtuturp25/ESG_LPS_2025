<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<title>Peta Kabupaten/Kota - FULL (jamin dropdown, hover, popup)</title>

<!-- OpenLayers + LayerSwitcher CSS -->
<link rel="stylesheet" href="resources/ol.css">
<link rel="stylesheet" href="resources/ol-layerswitcher.css">

<!-- Choices.js CSS (searchable dropdown) -->
<link rel="stylesheet" href="resources/choices.min.css">

<style>
    :root { --sidebar-width: 300px; }
    html, body { height: 100%; margin: 0; padding: 0; font-family: Arial, sans-serif; }
    /* Sidebar kiri */
    #sidebar {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: var(--sidebar-width);
        background: #fff;
        border-right: 1px solid #ddd;
        padding: 12px;
        box-sizing: border-box;
        overflow-y: auto;
        z-index: 1100;
    }
    #sidebar h2 { margin: 6px 0 12px 0; font-size: 16px; }
    #kabupatenSelect { width: 100%; box-sizing: border-box; padding: 6px; font-size: 14px; }
    .legend { margin-top: 18px; }
    .legend-item { display:flex; align-items:center; margin-bottom:8px; }
    .legend-color { width:22px; height:14px; margin-right:8px; border:1px solid #ccc; }
    .legend-label { font-size: 13px; color: #222; }

    /* Map area */
    #map { position: absolute; left: var(--sidebar-width); top: 0; right: 0; bottom: 0; }

    /* Popup */
    .ol-popup {
        position: absolute;
        background-color: white;
        box-shadow: 0 1px 4px rgba(0,0,0,0.2);
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #cccccc;
        min-width: 220px;
        z-index:1200;
    }
    .ol-popup-closer { position: absolute; top: 4px; right: 6px; text-decoration: none; color: #333; }
    .popup-table { width:100%; border-collapse: collapse; font-size: 13px; }
    .popup-table td:first-child { font-weight:600; padding-right:8px; vertical-align: top; width:40%; }
    .popup-cluster { display:inline-block; padding:4px 8px; border-radius:4px; color:#fff; font-weight:600; margin-left:6px; }
</style>
</head>
<body>

<!-- Sidebar -->
<div id="sidebar">
    <h2>Pilih Kabupaten / Kota</h2>
    <select id="kabupatenSelect" placeholder="Pilih Kabupaten/Kota"></select>

    <div class="legend">
        <h3 style="font-size:14px; margin-bottom:8px;">Legend Klaster</h3>
        <div class="legend-item"><div class="legend-color" style="background:#85b66f;"></div><div class="legend-label">Klaster 1</div></div>
        <div class="legend-item"><div class="legend-color" style="background:#fec980;"></div><div class="legend-label">Klaster 2</div></div>
        <div class="legend-item"><div class="legend-color" style="background:#ff0900;"></div><div class="legend-label">Klaster 3</div></div>
    </div>
</div>

<!-- Map -->
<div id="map">
    <div id="popup" class="ol-popup" style="display:none;">
        <a href="#" id="popup-closer" class="ol-popup-closer">âœ•</a>
        <div id="popup-content"></div>
    </div>
</div>

<!-- OpenLayers & LayerSwitcher -->
<script src="resources/ol.js"></script>
<script src="resources/ol-layerswitcher.js"></script>

<!-- qgis2web support -->
<script src="resources/qgis2web_expressions.js"></script>
<script src="resources/functions.js"></script>

<!-- ALL LAYERS (full list) -->
<script src="layers/Pacitan_1.js"></script>
<script src="layers/Ponorogo_2.js"></script>
<script src="layers/Trenggalek_3.js"></script>
<script src="layers/Tulungagung_4.js"></script>
<script src="layers/Blitar_5.js"></script>
<script src="layers/KotaBlitar_6.js"></script>
<script src="layers/Kediri_7.js"></script>
<script src="layers/KotaKediri_8.js"></script>
<script src="layers/Malang_9.js"></script>
<script src="layers/KotaMalang_10.js"></script>
<script src="layers/Lumajang_11.js"></script>
<script src="layers/Jember_12.js"></script>
<script src="layers/Banyuwangi_13.js"></script>
<script src="layers/Bondowoso_14.js"></script>
<script src="layers/Situbondo_15.js"></script>
<script src="layers/Probolinggo_16.js"></script>
<script src="layers/KotaProbolinggo_17.js"></script>
<script src="layers/Pasuruan_18.js"></script>
<script src="layers/KotaPasuruan_19.js"></script>
<script src="layers/Sidoarjo_20.js"></script>
<script src="layers/Mojokerto_21.js"></script>
<script src="layers/KotaMojokerto_22.js"></script>
<script src="layers/Jombang_23.js"></script>
<script src="layers/Ngajuk_24.js"></script>
<script src="layers/Madiun_25.js"></script>
<script src="layers/KotaMadiun_26.js"></script>
<script src="layers/Magetan_27.js"></script>
<script src="layers/Ngawi_28.js"></script>
<script src="layers/Bojonegoro_29.js"></script>
<script src="layers/Tuban_30.js"></script>
<script src="layers/Lamongan_31.js"></script>
<script src="layers/Gresik_32.js"></script>
<script src="layers/Bangkalan_33.js"></script>
<script src="layers/Sampang_34.js"></script>
<script src="layers/Pamekasan_35.js"></script>
<script src="layers/Sumenep_36.js"></script>
<script src="layers/Surabaya_37.js"></script>
<script src="layers/Batu_38.js"></script>
<script src="layers/BatasKabupaten_39.js"></script>

<!-- ALL STYLES (full list) -->
<script src="styles/Pacitan_1_style.js"></script>
<script src="styles/Ponorogo_2_style.js"></script>
<script src="styles/Trenggalek_3_style.js"></script>
<script src="styles/Tulungagung_4_style.js"></script>
<script src="styles/Blitar_5_style.js"></script>
<script src="styles/KotaBlitar_6_style.js"></script>
<script src="styles/Kediri_7_style.js"></script>
<script src="styles/KotaKediri_8_style.js"></script>
<script src="styles/Malang_9_style.js"></script>
<script src="styles/KotaMalang_10_style.js"></script>
<script src="styles/Lumajang_11_style.js"></script>
<script src="styles/Jember_12_style.js"></script>
<script src="styles/Banyuwangi_13_style.js"></script>
<script src="styles/Bondowoso_14_style.js"></script>
<script src="styles/Situbondo_15_style.js"></script>
<script src="styles/Probolinggo_16_style.js"></script>
<script src="styles/KotaProbolinggo_17_style.js"></script>
<script src="styles/Pasuruan_18_style.js"></script>
<script src="styles/KotaPasuruan_19_style.js"></script>
<script src="styles/Sidoarjo_20_style.js"></script>
<script src="styles/Mojokerto_21_style.js"></script>
<script src="styles/KotaMojokerto_22_style.js"></script>
<script src="styles/Jombang_23_style.js"></script>
<script src="styles/Ngajuk_24_style.js"></script>
<script src="styles/Madiun_25_style.js"></script>
<script src="styles/KotaMadiun_26_style.js"></script>
<script src="styles/Magetan_27_style.js"></script>
<script src="styles/Ngawi_28_style.js"></script>
<script src="styles/Bojonegoro_29_style.js"></script>
<script src="styles/Tuban_30_style.js"></script>
<script src="styles/Lamongan_31_style.js"></script>
<script src="styles/Gresik_32_style.js"></script>
<script src="styles/Bangkalan_33_style.js"></script>
<script src="styles/Sampang_34_style.js"></script>
<script src="styles/Pamekasan_35_style.js"></script>
<script src="styles/Sumenep_36_style.js"></script>
<script src="styles/Surabaya_37_style.js"></script>
<script src="styles/Batu_38_style.js"></script>
<script src="styles/BatasKabupaten_39_style.js"></script>

<!-- layers.js & qgis2web glue -->
<script src="layers/layers.js"></script>
<script src="resources/qgis2web.js"></script>

<!-- Choices.js -->
<script src="resources/choices.min.js"></script>

<script>
/*
  Safe init: wait until map and layersList are ready before wiring dropdown/hover/popup.
  Uses polling with timeout to avoid race conditions.
*/
(function() {
    const MAX_TRIES = 60;      // try up to ~6s (60 * 100ms)
    const INTERVAL_MS = 100;
    let tries = 0;

    function initWhenReady() {
        tries++;
        if (typeof window.map !== 'undefined' && typeof window.layersList !== 'undefined') {
            try {
                initUI(window.map, window.layersList);
            } catch (e) {
                console.error('Init failed:', e);
            }
        } else if (tries < MAX_TRIES) {
            setTimeout(initWhenReady, INTERVAL_MS);
        } else {
            console.error('Timeout waiting for map/layersList. Check that layers/layers.js and resources/qgis2web.js are loaded.');
        }
    }
    window.addEventListener('load', initWhenReady);
})();

function initUI(map, layersList) {
    // Elements
    const selectElem = document.getElementById('kabupatenSelect');
    const popupEl = document.getElementById('popup');
    const popupContent = document.getElementById('popup-content');
    const popupCloser = document.getElementById('popup-closer');

    // Build kabupatenLayers: include only vector layers for kab/kota, exclude 'Batas' & basemaps
    const kabupatenLayers = layersList.filter(l => {
        const rawTitle = (l.get('popuplayertitle') || l.get('title') || '').toString();
        if (!rawTitle) return false;
        if (/Batas/i.test(rawTitle)) return false;
        if (/Google Satellite/i.test(rawTitle)) return false;
        // Accept layers that have features (vector)
        const src = l.getSource ? l.getSource() : null;
        if (!src) return false;
        // Good if source has getFeatures function or getExtent
        if (typeof src.getFeatures !== 'function' && typeof src.getExtent !== 'function') return false;
        return true;
    });

    // Derive display names (prefer popuplayertitle)
    const kabupatenNames = [];
    kabupatenLayers.forEach(l => {
        const name = (l.get('popuplayertitle') || l.get('title') || '').toString();
        if (name && kabupatenNames.indexOf(name) === -1) kabupatenNames.push(name);
    });
    kabupatenNames.sort((a,b) => a.localeCompare(b, 'id'));

    // Populate dropdown (clear first)
    selectElem.innerHTML = '';
    kabupatenNames.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        selectElem.appendChild(opt);
    });

    // Initialize Choices if present (searchable)
    try {
        if (typeof Choices !== 'undefined') {
            new Choices(selectElem, { searchEnabled: true, itemSelectText: '' });
        }
    } catch (e) {
        console.warn('Choices init error:', e);
    }

    // helper: find layer by display name
    function findLayerByName(displayName) {
        return kabupatenLayers.find(l => ((l.get('popuplayertitle') || l.get('title') || '').toString()) === displayName);
    }

    // robust extent computation
    function computeLayerExtent(layer) {
        const src = layer.getSource();
        let extent = null;
        try { if (typeof src.getExtent === 'function') extent = src.getExtent(); } catch(e){ extent = null; }
        if (!extent || (Array.isArray(extent) && extent.every(v=>v===0))) {
            try {
                const feats = (typeof src.getFeatures === 'function') ? src.getFeatures() : [];
                if (feats && feats.length) {
                    extent = feats[0].getGeometry().getExtent().slice();
                    for (let i=1;i<feats.length;i++) ol.extent.extend(extent, feats[i].getGeometry().getExtent());
                }
            } catch(err) { extent = null; }
        }
        return extent;
    }

    // Dropdown change => fit extent
    selectElem.addEventListener('change', function() {
        const name = this.value;
        const layer = findLayerByName(name);
        if (!layer) return;
        const extent = computeLayerExtent(layer);
        if (extent) map.getView().fit(extent, { duration: 800, padding: [80,80,80,80], maxZoom: 12 });
    });

    // Hover highlight (yellow transparent)
    const hoverSelect = new ol.interaction.Select({
        condition: ol.events.condition.pointerMove,
        layers: kabupatenLayers,
        style: new ol.style.Style({
            stroke: new ol.style.Stroke({ color: 'yellow', width: 2 }),
            fill: new ol.style.Fill({ color: 'rgba(255,255,0,0.35)' })
        })
    });
    map.addInteraction(hoverSelect);

    // Popup overlay
    const overlay = new ol.Overlay({
        element: popupEl,
        autoPan: { animation: { duration: 200 } }
    });
    map.addOverlay(overlay);

    // close popup
    if (popupCloser) popupCloser.onclick = function(e) {
        e.preventDefault();
        overlay.setPosition(undefined);
        popupEl.style.display = 'none';
        popupCloser.blur();
        return false;
    };

    // On map click -> show popup for topmost kabupaten feature
    map.on('singleclick', function(evt) {
        // close previous
        overlay.setPosition(undefined);
        popupEl.style.display = 'none';

        let found = null;
        map.forEachFeatureAtPixel(evt.pixel, function(feature, layer) {
            if (kabupatenLayers.indexOf(layer) !== -1) {
                if (!found) found = { feature: feature, layer: layer };
            }
        }, { hitTolerance: 4 });

        if (!found) return;

        const f = found.feature;
        const props = (typeof f.getProperties === 'function') ? f.getProperties() : {};

        // Fields mapping (as you gave)
        const namaObj = props['NAMOBJ'] ?? '';
        const desa = props['WADMKD'] ?? '';
        const kab = props['WADMKK'] ?? '';
        const E = props['E'] ?? '';
        const S = props['S'] ?? '';
        const G = props['G'] ?? '';
        const ESG = props['ESG'] ?? '';
        let clusterRaw = props['Cluster'];
        if (clusterRaw === undefined) clusterRaw = props['CLUSTER'] ?? props['cluster'] ?? null;

        let clusterName = 'â€”';
        let clusterColor = '#666';
        if (clusterRaw !== null && clusterRaw !== undefined && clusterRaw !== '') {
            const cnum = Number(clusterRaw);
            if (isFinite(cnum)) {
                const idx = cnum + 1;
                clusterName = 'Klaster ' + idx;
                if (idx === 1) clusterColor = '#85b66f';
                else if (idx === 2) clusterColor = '#fec980';
                else if (idx === 3) clusterColor = '#ff0900';
                else clusterColor = '#666';
            } else {
                clusterName = String(clusterRaw);
            }
        }

        const html = `
            <table class="popup-table">
                <tr><td>NAMOBJ</td><td>${escapeHtml(namaObj)}</td></tr>
                <tr><td>Desa (WADMKD)</td><td>${escapeHtml(desa)}</td></tr>
                <tr><td>Kabupaten (WADMKK)</td><td>${escapeHtml(kab)}</td></tr>
                <tr><td>E</td><td>${formatNumber(E)}</td></tr>
                <tr><td>S</td><td>${formatNumber(S)}</td></tr>
                <tr><td>G</td><td>${formatNumber(G)}</td></tr>
                <tr><td>ESG</td><td>${formatNumber(ESG)}</td></tr>
                <tr><td>Nama Klaster</td><td><span class="popup-cluster" style="background:${clusterColor}">${escapeHtml(clusterName)}</span></td></tr>
            </table>
        `;
        popupContent.innerHTML = html;
        overlay.setPosition(evt.coordinate);
        popupEl.style.display = 'block';
    });

    // Ensure popup and hover work from the very beginning (they are now attached)
    // Initial view: focus on Surabaya if exists; otherwise fit all kabupaten extents
    (function initialView() {
        let surabayaLayer = kabupatenLayers.find(l => /Surabaya/i.test((l.get('popuplayertitle') || l.get('title') || '').toString()));
        let extent = null;
        if (surabayaLayer) extent = computeLayerExtent(surabayaLayer);
        if (extent) {
            map.getView().fit(extent, { padding: [60,60,60,60] });
            return;
        }
        // else fit all
        let fullExtent = null;
        kabupatenLayers.forEach(layer => {
            const ext = computeLayerExtent(layer);
            if (ext) {
                if (!fullExtent) fullExtent = ext.slice();
                else ol.extent.extend(fullExtent, ext);
            }
        });
        if (fullExtent) map.getView().fit(fullExtent, { padding: [80,80,80,80] });
    })();

    // Helpers
    function escapeHtml(str) {
        if (str === null || str === undefined) return '';
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }
    function formatNumber(x) {
        if (x === null || x === undefined || x === '') return 'â€”';
        const n = Number(x);
        if (!isFinite(n)) return escapeHtml(String(x));
        return n.toLocaleString(undefined, { maximumFractionDigits: 4 });
    }

    // Done initUI
} // end initUI
</script>

</body>
</html>
