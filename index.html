<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Peta ESG Rev</title>
    <link rel="stylesheet" href="./resources/ol.css">
    <link rel="stylesheet" href="./resources/qgis2web.css">
    <style>
        html, body { 
            margin: 0; 
            padding: 0; 
        }
        #map { 
            width: 100%; 
            height: 100vh; 
        }

        /* Styling untuk Popup */
        .ol-popup {
            position: absolute;
            background-color: white;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #cccccc;
            bottom: 12px;
            left: -50px;
            min-width: 280px;
            font-family: Arial, sans-serif;
            font-size: 14px;
        }
        .ol-popup:after, .ol-popup:before {
            top: 100%;
            border: solid transparent;
            content: " ";
            height: 0;
            width: 0;
            position: absolute;
            pointer-events: none;
        }
        .ol-popup:after {
            border-top-color: white;
            border-width: 10px;
            left: 48px;
            margin-left: -10px;
        }
        .ol-popup:before {
            border-top-color: #cccccc;
            border-width: 11px;
            left: 48px;
            margin-left: -11px;
        }
        .ol-popup-closer {
            text-decoration: none;
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 1.2em;
            color: #333;
        }
        .ol-popup-closer:after {
            content: "✖";
        }
        #popup-content b {
            color: #005A9E;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div id="popup" class="ol-popup">
        <a href="#" id="popup-closer" class="ol-popup-closer"></a>
        <div id="popup-content"></div>
    </div>

    <script src="./resources/ol.js"></script>
    <script src="layers/Pacitan_1.js"></script>
    <script src="layers/Ponorogo_2.js"></script>
    <script src="layers/Trenggalek_3.js"></script>
    <script src="layers/Tulungagung_4.js"></script>
    <script src="layers/Blitar_5.js"></script>
    <script src="layers/KotaBlitar_6.js"></script>
    <script src="layers/Kediri_7.js"></script>
    <script src="layers/KotaKediri_8.js"></script>
    <script src="layers/Malang_9.js"></script>
    <script src="layers/KotaMalang_10.js"></script>
    <script src="layers/Lumajang_11.js"></script>
    <script src="layers/Jember_12.js"></script>
    <script src="layers/Banyuwangi_13.js"></script>
    <script src="layers/Bondowoso_14.js"></script>
    <script src="layers/Situbondo_15.js"></script>
    <script src="layers/Probolinggo_16.js"></script>
    <script src="layers/KotaProbolinggo_17.js"></script>
    <script src="layers/Pasuruan_18.js"></script>
    <script src="layers/KotaPasuruan_19.js"></script>
    <script src="layers/Sidoarjo_20.js"></script>
    <script src="layers/Mojokerto_21.js"></script>
    <script src="layers/KotaMojokerto_22.js"></script>
    <script src="layers/Jombang_23.js"></script>
    <script src="layers/Ngajuk_24.js"></script>
    <script src="layers/Madiun_25.js"></script>
    <script src="layers/KotaMadiun_26.js"></script>
    <script src="layers/Magetan_27.js"></script>
    <script src="layers/Ngawi_28.js"></script>
    <script src="layers/Bojonegoro_29.js"></script>
    <script src="layers/Tuban_30.js"></script>
    <script src="layers/Lamongan_31.js"></script>
    <script src="layers/Gresik_32.js"></script>
    <script src="layers/Bangkalan_33.js"></script>
    <script src="layers/Sampang_34.js"></script>
    <script src="layers/Pamekasan_35.js"></script>
    <script src="layers/Sumenep_36.js"></script>
    <script src="layers/Surabaya_37.js"></script>
    <script src="layers/Batu_38.js"></script>
    <script src="layers/BatasKabupaten_39.js"></script>
    <script src="./layers/layers.js"></script>
    <script src="./resources/qgis2web.js"></script>

    <script>
    window.addEventListener("load", function() {
        // Pastikan variabel 'map' dari qgis2web.js sudah siap
        if (typeof map === "undefined") {
            console.error("❌ Variabel 'map' tidak ditemukan. Pastikan qgis2web.js dimuat dengan benar.");
            return;
        }

        // === Konfigurasi Popup ===
        const container = document.getElementById('popup');
        const content_element = document.getElementById('popup-content');
        const closer = document.getElementById('popup-closer');

        const overlay = new ol.Overlay({
            element: container,
            autoPan: { animation: { duration: 250 } }
        });
        map.addOverlay(overlay);

        closer.onclick = function() {
            overlay.setPosition(undefined);
            closer.blur();
            return false;
        };

        // === Konfigurasi Hover ===
        const hoverStyle = new ol.style.Style({
            stroke: new ol.style.Stroke({ color: '#ffcc00', width: 3 }),
            fill: new ol.style.Fill({ color: 'rgba(255, 204, 0, 0.4)' }),
            zIndex: 1 // Pastikan style hover selalu di atas
        });
        
        let highlightedFeature = null;

        /**
         * Fungsi untuk memfilter feature yang interaktif.
         * Hanya feature yang memiliki atribut 'ESG' yang akan dianggap interaktif.
         * Ini secara efektif mengabaikan layer seperti 'BatasKabupaten'.
         */
        const getInteractiveFeature = (pixel) => {
            return map.forEachFeatureAtPixel(pixel, function(feature) {
                if (feature.get('ESG') !== undefined) {
                    return feature;
                }
            });
        };

        // === Event Handler Peta ===

        // 1. Event untuk Klik (menampilkan Popup)
        map.on('singleclick', function(evt) {
            const feature = getInteractiveFeature(evt.pixel);
            
            if (feature) {
                const props = feature.getProperties();
                const desa = props['WADMKD'] || '-';
                const kabupaten = props['WADMKK'] || '-';
                const e_val = props['E'] !== undefined ? parseFloat(props['E']).toFixed(4) : '-';
                const s_val = props['S'] !== undefined ? parseFloat(props['S']).toFixed(4) : '-';
                const g_val = props['G'] !== undefined ? parseFloat(props['G']).toFixed(4) : '-';
                const esg_val = props['ESG'] !== undefined ? parseFloat(props['ESG']).toFixed(4) : '-';
                const clusterNum = props['Cluster'] !== undefined ? props['Cluster'] + 1 : '-';
                
                let clusterName = '-';
                if (clusterNum === 1) clusterName = "Klaster 1";
                else if (clusterNum === 2) clusterName = "Klaster 2";
                else if (clusterNum === 3) clusterName = "Klaster 3";

                content_element.innerHTML = `
                    <b>Kab/Kota:</b> ${kabupaten}<br>
                    <b>Desa/Kel:</b> ${desa}<br><hr style="margin: 5px 0;">
                    <b>E:</b> ${e_val}<br>
                    <b>S:</b> ${s_val}<br>
                    <b>G:</b> ${g_val}<br>
                    <b>Nilai ESG:</b> ${esg_val}<br>
                    <b>Klaster:</b> ${clusterName}
                `;
                overlay.setPosition(evt.coordinate);
            } else {
                overlay.setPosition(undefined);
            }
        });

        // 2. Event untuk Gerakan Mouse (efek Hover & perubahan kursor)
        map.on('pointermove', function(evt) {
            if (evt.dragging) {
                return; // Jangan lakukan apa-apa jika sedang menggeser peta
            }

            const feature = getInteractiveFeature(evt.pixel);
            
            // Ubah style kursor
            map.getTargetElement().style.cursor = feature ? 'pointer' : '';

            // Terapkan/hapus style hover
            if (feature !== highlightedFeature) {
                if (highlightedFeature) {
                    highlightedFeature.setStyle(undefined); // Kembalikan style feature sebelumnya
                }
                if (feature) {
                    feature.setStyle(hoverStyle); // Terapkan style hover ke feature baru
                }
                highlightedFeature = feature; // Simpan feature yang sedang di-hover
            }
        });
    });
    </script>
</body>
</html>
