<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="initial-scale=1,width=device-width,maximum-scale=1,user-scalable=no">
  <link rel="stylesheet" href="./resources/ol.css">
  <link rel="stylesheet" href="./resources/fontawesome-all.min.css">
  <link rel="stylesheet" href="./resources/photon-geocoder-autocomplete.min.css">
  <link rel="stylesheet" href="./resources/ol-layerswitcher.css">
  <link rel="stylesheet" href="./resources/qgis2web.css">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      background-color: #ffffff;
      overflow: hidden;
      font-family: Arial, sans-serif;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    .ol-popup {
      background-color: white;
      padding: 15px;
      border-radius: 5px;
    }
    .loading-indicator {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 4px;
      font-size: 12px;
      z-index: 9999;
    }
  </style>
  <title>ESG Jawa Timur Rev 22</title>
</head>
<body>
<div id="map">
  <div id="popup" class="ol-popup">
    <a href="#" id="popup-closer" class="ol-popup-closer"></a>
    <div id="popup-content"></div>
  </div>
</div>
<div id="loading" class="loading-indicator" style="display: none;">
  Loading: <span id="loading-percent">0%</span>
</div>

<!-- QGIS2Web & OL resources -->
<script src="resources/qgis2web_expressions.js"></script>
<script src="resources/functions.js"></script>
<script src="resources/ol.js"></script>
<script src="resources/ol-layerswitcher.js"></script>
<script src="resources/photon-geocoder-autocomplete.min.js"></script>
<script src="resources/Autolinker.min.js"></script>

<!-- Layer definitions -->
<script src="layers/layers.js"></script>
<script src="resources/qgis2web.js"></script>

<script>
  // === Base layer satelit Google ===
  const satelliteLayer = new ol.layer.Tile({
    title: 'Satellite',
    type: 'base',
    source: new ol.source.XYZ({
      url: 'https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}'
    }),
    visible: true
  });

  // === Cari layer BatasKabupaten & Surabaya ===
  const batasKabupatenLayer = layersList.find(l => l.get('title') === 'BatasKabupaten');
  const surabayaLayer = layersList.find(l => l.get('title') === 'Surabaya');

  if (batasKabupatenLayer) batasKabupatenLayer.setVisible(true);
  if (surabayaLayer) surabayaLayer.setVisible(true);

  // Matikan semua layer lain
  layersList.forEach(l => {
    if (l !== batasKabupatenLayer && l !== surabayaLayer) {
      if (l.get('type') !== 'base') l.setVisible(false);
    }
  });

  // Tambahkan base layer di paling atas
  layersList.unshift(satelliteLayer);

  // === Map ===
  const map = new ol.Map({
    target: 'map',
    layers: layersList,
    view: new ol.View({
      center: ol.proj.fromLonLat([112.7, -7.5]),
      zoom: 9
    }),
    controls: ol.control.defaults().extend([
      new ol.control.ScaleLine(),
      new ol.control.Zoom(),
      new ol.control.LayerSwitcher()
    ])
  });

  // === Popup ===
  const overlay = new ol.Overlay({
    element: document.getElementById('popup'),
    autoPan: true,
    autoPanAnimation: { duration: 250 }
  });
  map.addOverlay(overlay);
  document.getElementById('popup-closer').onclick = function () {
    overlay.setPosition(undefined);
    this.blur();
    return false;
  };

  // === Loading indicator ===
  const loadingDiv = document.getElementById('loading');
  const loadingPercent = document.getElementById('loading-percent');
  let loadingCount = 0;
  let loadedCount = 0;

  function updateLoading() {
    if (loadingCount > 0) {
      const percent = Math.round((loadedCount / loadingCount) * 100);
      loadingPercent.textContent = percent + '%';
      loadingDiv.style.display = 'block';
      if (percent >= 100) {
        setTimeout(() => { loadingDiv.style.display = 'none'; }, 500);
      }
    }
  }

  map.getLayers().forEach(layer => {
    if (layer.getSource && layer.getSource().on) {
      layer.getSource().on('tileloadstart', () => {
        loadingCount++;
        updateLoading();
      });
      layer.getSource().on('tileloadend', () => {
        loadedCount++;
        updateLoading();
      });
      layer.getSource().on('tileloaderror', () => {
        loadedCount++;
        updateLoading();
      });
    }
  });
</script>
</body>
</html>
