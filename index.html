<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  
  <link rel="stylesheet" href="./resources/ol.css">
  <link rel="stylesheet" href="resources/fontawesome-all.min.css">
  <link rel="stylesheet" href="./resources/qgis2web.css">

  <style>
    /* Membuat peta responsif dan menghilangkan style lama */
    html, body, #map { margin: 0; padding: 0; width: 100%; height: 100%; font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; overflow: hidden; }
    /* Panel kontrol di atas peta */
    #topbar { position: absolute; left: 10px; top: 10px; z-index: 1100; background: white; padding: 8px 10px; border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 10px; flex-wrap: wrap; max-width: calc(100vw - 40px); }
    label { font-size: 13px; font-weight: 600; white-space: nowrap; }
    select, button { padding: 6px 10px; font-size: 13px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; outline: none; min-width: 150px; }
    button { cursor: pointer; }
    /* Popup */
    .ol-popup { position: absolute; background-color: white; box-shadow: 0 1px 4px rgba(0,0,0,0.2); padding: 15px; border-radius: 10px; border: 1px solid #cccccc; bottom: 12px; left: -50px; min-width: 280px; font-size: 14px; }
    .ol-popup-closer { text-decoration: none; position: absolute; top: 2px; right: 8px; }
    #popup-content { line-height: 1.8; }
  </style>
  <title>Peta Interaktif Jawa Timur</title>
</head>
<body>
  <!-- Elemen HTML untuk Dropdown -->
  <div id="topbar">
    <label for="kabupatenSelect">Pilih Kabupaten/Kota:</label>
    <select id="kabupatenSelect"><option>Memuat Peta...</option></select>
    <button id="btnReset">Reset</button>
  </div>

  <!-- Kontainer Peta dari qgis2web -->
  <div id="map">
    <div id="popup" class="ol-popup">
      <a href="#" id="popup-closer" class="ol-popup-closer"></a>
      <div id="popup-content"></div>
    </div>
  </div>
  
  <!-- Semua skrip asli dari qgis2web -->
  <script src="resources/qgis2web_expressions.js"></script>
  <script src="./resources/functions.js"></script>
  <script src="./resources/ol.js"></script>
  <script src="./resources/ol-layerswitcher.js"></script>
  <script src="layers/Pacitan_1.js"></script><script src="layers/Ponorogo_2.js"></script><script src="layers/Trenggalek_3.js"></script><script src="layers/Tulungagung_4.js"></script><script src="layers/Blitar_5.js"></script><script src="layers/KotaBlitar_6.js"></script><script src="layers/Kediri_7.js"></script><script src="layers/KotaKediri_8.js"></script><script src="layers/Malang_9.js"></script><script src="layers/KotaMalang_10.js"></script><script src="layers/Lumajang_11.js"></script><script src="layers/Jember_12.js"></script><script src="layers/Banyuwangi_13.js"></script><script src="layers/Bondowoso_14.js"></script><script src="layers/Situbondo_15.js"></script><script src="layers/Probolinggo_16.js"></script><script src="layers/KotaProbolinggo_17.js"></script><script src="layers/Pasuruan_18.js"></script><script src="layers/KotaPasuruan_19.js"></script><script src="layers/Sidoarjo_20.js"></script><script src="layers/Mojokerto_21.js"></script><script src="layers/KotaMojokerto_22.js"></script><script src="layers/Jombang_23.js"></script><script src="layers/Ngajuk_24.js"></script><script src="layers/Madiun_25.js"></script><script src="layers/KotaMadiun_26.js"></script><script src="layers/Magetan_27.js"></script><script src="layers/Ngawi_28.js"></script><script src="layers/Bojonegoro_29.js"></script><script src="layers/Tuban_30.js"></script><script src="layers/Lamongan_31.js"></script><script src="layers/Gresik_32.js"></script><script src="layers/Bangkalan_33.js"></script><script src="layers/Sampang_34.js"></script><script src="layers/Pamekasan_35.js"></script><script src="layers/Sumenep_36.js"></script><script src="layers/Surabaya_37.js"></script><script src="layers/Batu_38.js"></script><script src="layers/BatasKabupaten_39.js"></script>
  <script src="styles/Pacitan_1_style.js"></script><script src="styles/Ponorogo_2_style.js"></script><script src="styles/Trenggalek_3_style.js"></script><script src="styles/Tulungagung_4_style.js"></script><script src="styles/Blitar_5_style.js"></script><script src="styles/KotaBlitar_6_style.js"></script><script src="styles/Kediri_7_style.js"></script><script src="styles/KotaKediri_8_style.js"></script><script src="styles/Malang_9_style.js"></script><script src="styles/KotaMalang_10_style.js"></script><script src="styles/Lumajang_11_style.js"></script><script src="styles/Jember_12_style.js"></script><script src="styles/Banyuwangi_13_style.js"></script><script src="styles/Bondowoso_14_style.js"></script><script src="styles/Situbondo_15_style.js"></script><script src="styles/Probolinggo_16_style.js"></script><script src="styles/KotaProbolinggo_17_style.js"></script><script src="styles/Pasuruan_18_style.js"></script><script src="styles/KotaPasuruan_19_style.js"></script><script src="styles/Sidoarjo_20_style.js"></script><script src="styles/Mojokerto_21_style.js"></script><script src="styles/KotaMojokerto_22_style.js"></script><script src="styles/Jombang_23_style.js"></script><script src="styles/Ngajuk_24_style.js"></script><script src="styles/Madiun_25_style.js"></script><script src="styles/KotaMadiun_26_style.js"></script><script src="styles/Magetan_27_style.js"></script><script src="styles/Ngawi_28_style.js"></script><script src="styles/Bojonegoro_29_style.js"></script><script src="styles/Tuban_30_style.js"></script><script src="styles/Lamongan_31_style.js"></script><script src="styles/Gresik_32_style.js"></script><script src="styles/Bangkalan_33_style.js"></script><script src="styles/Sampang_34_style.js"></script><script src="styles/Pamekasan_35_style.js"></script><script src="styles/Sumenep_36_style.js"></script><script src="styles/Surabaya_37_style.js"></script><script src="styles/Batu_38_style.js"></script><script src="styles/BatasKabupaten_39_style.js"></script>
  <script src="./layers/layers.js" type="text/javascript"></script>
  <script src="./resources/Autolinker.min.js"></script>
  <script src="./resources/qgis2web.js"></script>
  
  <!-- ===================================================================== -->
  <!-- ==========         SKRIP KUSTOM (LOGIKA OTOMATIS)       ========== -->
  <!-- ===================================================================== -->
  <script>
    function initializeCustomFeatures() {
        console.log("Peta siap. Memulai skrip kustom.");

        const kabSelect = document.getElementById('kabupatenSelect');
        const resetButton = document.getElementById('btnReset');
        const allMapLayers = map.getLayers().getArray();
        let kabupatenLayers = []; // Hanya untuk menyimpan layer-layer kabupaten
        let daftarNamaKabupaten = []; // Daftar nama resmi dari peta

        // --- 1. MEMBANGUN DAFTAR DROPDOWN SECARA OTOMATIS ---
        console.log("Membaca layer dari peta untuk membangun dropdown...");
        allMapLayers.forEach(layer => {
            const title = layer.get('title');
            // Kita anggap semua layer vektor selain 'BatasKabupaten' adalah layer kabupaten
            if (title && title !== 'BatasKabupaten' && layer instanceof ol.layer.Vector) {
                kabupatenLayers.push(layer);
                daftarNamaKabupaten.push(title);
            }
        });

        // Urutkan nama secara alfabet
        daftarNamaKabupaten.sort();

        kabSelect.innerHTML = '<option value="">-- Semua Kabupaten --</option>';
        daftarNamaKabupaten.forEach(namaAsli => {
            const opt = document.createElement('option');
            opt.value = namaAsli;
            opt.textContent = namaAsli.replace(/([A-Z])/g, ' $1').trim(); 
            kabSelect.appendChild(opt);
        });
        console.log(`Dropdown berhasil diisi dengan ${daftarNamaKabupaten.length} kabupaten/kota.`);

        // --- 2. FUNGSI UNTUK MENGONTROL PETA ---
        function setLayerVisibility(selectedTitle) {
            let targetLayer = null;
            kabupatenLayers.forEach(layer => {
                const isVisible = (layer.get('title') === selectedTitle);
                layer.setVisible(isVisible);
                if (isVisible) { targetLayer = layer; }
            });
            return targetLayer;
        }
        
        function resetMapView() {
            kabupatenLayers.forEach(layer => layer.setVisible(true));
            kabSelect.value = '';
        }

        // --- 3. MEMBERI PERINTAH PADA TOMBOL DAN DROPDOWN ---
        kabSelect.addEventListener('change', function() {
            const selectedName = this.value;
            if (selectedName === '') {
                resetMapView();
                return;
            }
            const targetLayer = setLayerVisibility(selectedName);
            if (targetLayer) {
                const source = targetLayer.getSource();
                if(source && source.getExtent()){
                    map.getView().fit(source.getExtent(), { padding: [50, 50, 50, 50], maxZoom: 12, duration: 500 });
                }
            }
        });
        resetButton.addEventListener('click', resetMapView);
    };

    // --- MEKANISME PALING STABIL UNTUK MENUNGGU PETA SIAP ---
    const mapReadyCheck = setInterval(function() {
        if (typeof map !== 'undefined' && typeof ol !== 'undefined') {
            clearInterval(mapReadyCheck); // Hentikan pengecekan
            initializeCustomFeatures(); // Jalankan fungsi utama kita
        }
    }, 100);

    // --- DIAGNOSIS JIKA PETA GAGAL TOTAL ---
    setTimeout(function() {
        if (typeof map === 'undefined') {
            clearInterval(mapReadyCheck);
            console.error("GAGAL TOTAL: Peta tidak berhasil dimuat setelah 5 detik.");
            alert("Peta gagal dimuat. Periksa Konsol (F12) dan tab Network untuk mencari file yang gagal dimuat (error 404).");
        }
    }, 5000);
  </script>
</body>
</html>
