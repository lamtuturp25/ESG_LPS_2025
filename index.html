<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Peta ESG dengan Popup & Hover</title>
<link rel="stylesheet" href="./resources/ol.css">
<link rel="stylesheet" href="./resources/qgis2web.css">
<style>
html, body { margin:0; padding:0; }
#map { width: 100%; height: 100vh; }

/* Popup */
.ol-popup {
    position: absolute;
    background-color: white;
    padding: 10px;
    border: 1px solid #cccccc;
    bottom: 12px;
    left: -50px;
    min-width: 200px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
    border-radius: 4px;
    pointer-events: auto; /* penting agar klik di popup bisa */
}
.ol-popup:after, .ol-popup:before {
    top: 100%;
    border: solid transparent;
    content: " ";
    height: 0;
    width: 0;
    position: absolute;
    pointer-events: none;
}
.ol-popup:after {
    border-top-color: white;
    border-width: 10px;
    left: 48px;
    margin-left: -10px;
}
.ol-popup:before {
    border-top-color: #cccccc;
    border-width: 11px;
    left: 48px;
    margin-left: -11px;
}
.ol-popup-closer {
    text-decoration: none;
    position: absolute;
    top: 2px;
    right: 8px;
    font-weight: bold;
    font-size: 16px;
    color: #333;
    cursor: pointer;
}

/* Hover style */
.hover-feature {
    stroke: #ffff00;
    stroke-width: 2;
    fill: rgba(255,255,0,0.3);
}
</style>
</head>
<body>
<div id="map"></div>

<!-- Popup -->
<div id="popup" class="ol-popup" style="display:none;">
    <a href="#" id="popup-closer" class="ol-popup-closer">&#215;</a>
    <div id="popup-content"></div>
</div>

<!-- JS bawaan qgis2web -->
<script src="./resources/ol.js"></script>
<script src="layers/Pacitan_1.js"></script>
<script src="layers/Ponorogo_2.js"></script>
<script src="layers/Trenggalek_3.js"></script>
<script src="layers/Tulungagung_4.js"></script>
<script src="layers/Blitar_5.js"></script>
<script src="layers/KotaBlitar_6.js"></script>
<script src="layers/Kediri_7.js"></script>
<script src="layers/KotaKediri_8.js"></script>
<script src="layers/Malang_9.js"></script>
<script src="layers/KotaMalang_10.js"></script>
<script src="layers/Lumajang_11.js"></script>
<script src="layers/Jember_12.js"></script>
<script src="layers/Banyuwangi_13.js"></script>
<script src="layers/Bondowoso_14.js"></script>
<script src="layers/Situbondo_15.js"></script>
<script src="layers/Probolinggo_16.js"></script>
<script src="layers/KotaProbolinggo_17.js"></script>
<script src="layers/Pasuruan_18.js"></script>
<script src="layers/KotaPasuruan_19.js"></script>
<script src="layers/Sidoarjo_20.js"></script>
<script src="layers/Mojokerto_21.js"></script>
<script src="layers/KotaMojokerto_22.js"></script>
<script src="layers/Jombang_23.js"></script>
<script src="layers/Ngajuk_24.js"></script>
<script src="layers/Madiun_25.js"></script>
<script src="layers/KotaMadiun_26.js"></script>
<script src="layers/Magetan_27.js"></script>
<script src="layers/Ngawi_28.js"></script>
<script src="layers/Bojonegoro_29.js"></script>
<script src="layers/Tuban_30.js"></script>
<script src="layers/Lamongan_31.js"></script>
<script src="layers/Gresik_32.js"></script>
<script src="layers/Bangkalan_33.js"></script>
<script src="layers/Sampang_34.js"></script>
<script src="layers/Pamekasan_35.js"></script>
<script src="layers/Sumenep_36.js"></script>
<script src="layers/Surabaya_37.js"></script>
<script src="layers/Batu_38.js"></script>
<script src="layers/BatasKabupaten_39.js"></script>
<script src="./layers/layers.js"></script>
<script src="./resources/qgis2web.js"></script>

<script>
window.addEventListener("load", function() {
    if (typeof map === "undefined" || typeof layersList === "undefined") {
        alert("‚ùå map/layersList tidak ditemukan. Pastikan qgis2web.js membuatnya global.");
        return;
    }

    // === Popup ===
    var container = document.getElementById('popup');
    var content = document.getElementById('popup-content');
    var closer = document.getElementById('popup-closer');

    var overlay = new ol.Overlay({
        element: container,
        autoPan: { animation: { duration: 250 } },
        autoPanMargin: 20
    });
    map.addOverlay(overlay);

    closer.onclick = function(evt) {
        evt.preventDefault();
        overlay.setPosition(undefined);
        container.style.display = "none";
        closer.blur();
        return false;
    };

    map.on('singleclick', function(evt) {
        var feature = map.forEachFeatureAtPixel(evt.pixel, function(f) { return f; });
        if (feature) {
            var props = feature.getProperties();
            var desa = props['WADMKD'] || '-';
            var kabupaten = props['WADMKK'] || '-';
            var e = props['E'] || '-';
            var s = props['S'] || '-';
            var g = props['G'] || '-';
            var esg = props['ESG'] || '-';
            var clusterNum = props['Cluster'] !== undefined ? props['Cluster'] + 1 : '-';
            var clusterName = (clusterNum == 1) ? "Klaster 1" :
                              (clusterNum == 2) ? "Klaster 2" :
                              (clusterNum == 3) ? "Klaster 3" : "-";

            content.innerHTML = `
                <b>Desa:</b> ${desa}<br>
                <b>Kabupaten:</b> ${kabupaten}<br>
                <b>E:</b> ${e}<br>
                <b>S:</b> ${s}<br>
                <b>G:</b> ${g}<br>
                <b>ESG:</b> ${esg}<br>
                <b>Klaster:</b> ${clusterName}
            `;
            container.style.display = "block";
            overlay.setPosition(evt.coordinate);
        } else {
            overlay.setPosition(undefined);
            container.style.display = "none";
        }
    });

    // === Hover ===
    var hoverStyle = new ol.style.Style({
        stroke: new ol.style.Stroke({ color: '#ffff00', width: 3 }),
        fill: new ol.style.Fill({ color: 'rgba(255,255,0,0.3)' })
    });

    var highlightedFeature;
    var originalStyle;

    map.on('pointermove', function(evt) {
        if (highlightedFeature) {
            // Kembalikan style asli fitur yang sudah dihover sebelumnya
            highlightedFeature.setStyle(originalStyle);
            highlightedFeature = null;
            originalStyle = null;
        }
        if (evt.dragging) return;  // Jangan hover saat drag peta

        var pixel = evt.pixel;
        var feature = map.forEachFeatureAtPixel(pixel, function(f) { return f; });

        if (feature) {
            highlightedFeature = feature;
            originalStyle = feature.getStyle();
            feature.setStyle(hoverStyle);
        }
    });

});
</script>
</body>
</html>
