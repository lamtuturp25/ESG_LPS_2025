<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <title>Peta Kabupaten & Desa (Revisi)</title>

  <link rel="stylesheet" href="./resources/ol.css" />
  <link rel="stylesheet" href="resources/fontawesome-all.min.css" />
  <link href="resources/photon-geocoder-autocomplete.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="./resources/ol-layerswitcher.css" />
  <link rel="stylesheet" href="./resources/qgis2web.css" />

  <style>
    html, body, #map {
      margin: 0; padding: 0; width: 100%; height: 100%;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    }
    .ol-control > * {
      background-color: #f8f8f8 !important;
      color: #444 !important;
      border-radius: 0;
    }
    .ol-attribution a, .gcd-gl-input::placeholder, .search-layer-input-search::placeholder {
      color: #444 !important;
    }
    .search-layer-input-search {
      background-color: #f8f8f8 !important;
    }
    .ol-control > *:focus, .ol-control > *:hover {
      background-color: rgba(248, 248, 248, 0.7) !important;
    }
    .ol-control {
      background-color: rgba(255,255,255,0.4) !important;
      padding: 2px !important;
    }
    /* Top bar */
    #topbar {
      position: absolute;
      left: 10px;
      top: 10px;
      z-index: 1100;
      background: rgba(255,255,255,0.95);
      padding: 8px 10px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      max-width: calc(100vw - 40px);
    }
    label {
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
    }
    select, input, button {
      padding: 6px 10px;
      font-size: 13px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-family: inherit;
      outline: none;
      min-width: 150px;
    }
    select:hover, input:hover, button:hover {
      border-color: #888;
    }
    select:focus, input:focus {
      border-color: #0066cc;
      box-shadow: 0 0 0 2px rgba(0, 102, 204, 0.2);
    }
    button {
      cursor: pointer;
      background-color: #eee;
      transition: all 0.2s;
      white-space: nowrap;
    }
    button:hover {
      background-color: #ddd;
      border-color: #999;
    }
    button:active {
      background-color: #ccc;
    }

    /* Dropdown styling */
    select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 8px center;
      background-size: 14px;
      padding-right: 30px;
    }

    /* Popup */
    .ol-popup {
      position: absolute;
      background-color: white;
      box-shadow: 0 1px 4px rgba(0,0,0,0.2);
      padding: 15px;
      border-radius: 10px;
      border: 1px solid #cccccc;
      bottom: 12px;
      left: -50px;
      min-width: 200px;
      font-size: 13px;
    }
    .ol-popup:after, .ol-popup:before {
      top: 100%;
      border: solid transparent;
      content: " ";
      height: 0;
      width: 0;
      position: absolute;
      pointer-events: none;
    }
    .ol-popup:after {
      border-top-color: white;
      border-width: 10px;
      left: 48px;
      margin-left: -10px;
    }
    .ol-popup:before {
      border-top-color: #cccccc;
      border-width: 11px;
      left: 48px;
      margin-left: -11px;
    }
    .ol-popup-closer {
      text-decoration: none;
      position: absolute;
      top: 2px;
      right: 8px;
      font-weight: bold;
      font-size: 18px;
      color: #aaa;
      cursor: pointer;
    }
    .ol-popup-closer:hover {
      color: #000;
    }
  </style>
</head>
<body>

  <div id="topbar">
    <label for="kabupatenSelect">Pilih Kabupaten/Kota:</label>
    <select id="kabupatenSelect"><option value="">-- Semua Kabupaten --</option></select>

    <label for="searchDesa">Cari Desa:</label>
    <input id="searchDesa" placeholder="ketik nama desa lalu Enter" />

    <button id="btnReset">Reset</button>
  </div>

  <div id="map">
    <div id="popup" class="ol-popup" style="display:none;">
      <a href="#" id="popup-closer" class="ol-popup-closer">&#215;</a>
      <div id="popup-content"></div>
    </div>
  </div>

  <script src="resources/qgis2web_expressions.js"></script>
  <script src="./resources/functions.js"></script>
  <script src="./resources/ol.js"></script>
  <script src="./resources/ol-layerswitcher.js"></script>
  <script src="resources/photon-geocoder-autocomplete.min.js"></script>

  <script src="layers/Pacitan_1.js"></script>
  <script src="layers/Ponorogo_2.js"></script>
  <script src="layers/Trenggalek_3.js"></script>
  <script src="layers/Tulungagung_4.js"></script>
  <script src="layers/Blitar_5.js"></script>
  <script src="layers/KotaBlitar_6.js"></script>
  <script src="layers/Kediri_7.js"></script>
  <script src="layers/KotaKediri_8.js"></script>
  <script src="layers/Malang_9.js"></script>
  <script src="layers/KotaMalang_10.js"></script>
  <script src="layers/Lumajang_11.js"></script>
  <script src="layers/Jember_12.js"></script>
  <script src="layers/Banyuwangi_13.js"></script>
  <script src="layers/Bondowoso_14.js"></script>
  <script src="layers/Situbondo_15.js"></script>
  <script src="layers/Probolinggo_16.js"></script>
  <script src="layers/KotaProbolinggo_17.js"></script>
  <script src="layers/Pasuruan_18.js"></script>
  <script src="layers/KotaPasuruan_19.js"></script>
  <script src="layers/Sidoarjo_20.js"></script>
  <script src="layers/Mojokerto_21.js"></script>
  <script src="layers/KotaMojokerto_22.js"></script>
  <script src="layers/Jombang_23.js"></script>
  <script src="layers/Ngajuk_24.js"></script>
  <script src="layers/Madiun_25.js"></script>
  <script src="layers/KotaMadiun_26.js"></script>
  <script src="layers/Magetan_27.js"></script>
  <script src="layers/Ngawi_28.js"></script>
  <script src="layers/Bojonegoro_29.js"></script>
  <script src="layers/Tuban_30.js"></script>
  <script src="layers/Lamongan_31.js"></script>
  <script src="layers/Gresik_32.js"></script>
  <script src="layers/Bangkalan_33.js"></script>
  <script src="layers/Sampang_34.js"></script>
  <script src="layers/Pamekasan_35.js"></script>
  <script src="layers/Sumenep_36.js"></script>
  <script src="layers/Surabaya_37.js"></script>
  <script src="layers/Batu_38.js"></script>
  <script src="layers/BatasKabupaten_39.js"></script>

  <script src="styles/Pacitan_1_style.js"></script>
  <script src="styles/Ponorogo_2_style.js"></script>
  <script src="styles/Trenggalek_3_style.js"></script>
  <script src="styles/Tulungagung_4_style.js"></script>
  <script src="styles/Blitar_5_style.js"></script>
  <script src="styles/KotaBlitar_6_style.js"></script>
  <script src="styles/Kediri_7_style.js"></script>
  <script src="styles/KotaKediri_8_style.js"></script>
  <script src="styles/Malang_9_style.js"></script>
  <script src="styles/KotaMalang_10_style.js"></script>
  <script src="styles/Lumajang_11_style.js"></script>
  <script src="styles/Jember_12_style.js"></script>
  <script src="styles/Banyuwangi_13_style.js"></script>
  <script src="styles/Bondowoso_14_style.js"></script>
  <script src="styles/Situbondo_15_style.js"></script>
  <script src="styles/Probolinggo_16_style.js"></script>
  <script src="styles/KotaProbolinggo_17_style.js"></script>
  <script src="styles/Pasuruan_18_style.js"></script>
  <script src="styles/KotaPasuruan_19_style.js"></script>
  <script src="styles/Sidoarjo_20_style.js"></script>
  <script src="styles/Mojokerto_21_style.js"></script>
  <script src="styles/KotaMojokerto_22_style.js"></script>
  <script src="styles/Jombang_23_style.js"></script>
  <script src="styles/Ngajuk_24_style.js"></script>
  <script src="styles/Madiun_25_style.js"></script>
  <script src="styles/KotaMadiun_26_style.js"></script>
  <script src="styles/Magetan_27_style.js"></script>
  <script src="styles/Ngawi_28_style.js"></script>
  <script src="styles/Bojonegoro_29_style.js"></script>
  <script src="styles/Tuban_30_style.js"></script>
  <script src="styles/Lamongan_31_style.js"></script>
  <script src="styles/Gresik_32_style.js"></script>
  <script src="styles/Bangkalan_33_style.js"></script>
  <script src="styles/Sampang_34_style.js"></script>
  <script src="styles/Pamekasan_35_style.js"></script>
  <script src="styles/Sumenep_36_style.js"></script>
  <script src="styles/Surabaya_37_style.js"></script>
  <script src="styles/Batu_38_style.js"></script>
  <script src="styles/BatasKabupaten_39_style.js"></script>

  <script src="./layers/layers.js"></script>
  <script src="./resources/Autolinker.min.js"></script>

  <script src="./resources/qgis2web.js"></script>

  <script>
    (function(){

      // Helper to prevent display of 'null' or 'undefined'
      function safeText(v){
        return (v === undefined || v === null || v === '') ? '-' : String(v);
      }

      // Wait until 'map' and 'layersList' are initialized by qgis2web.js
      function waitForCondition(conditionFn, interval=100, timeout=10000){
        return new Promise((resolve)=>{
          const start = Date.now();
          (function check(){
            if(conditionFn()) return resolve(true);
            if(Date.now() - start > timeout) return resolve(false);
            setTimeout(check, interval);
          })();
        });
      }

      waitForCondition(() => typeof map !== 'undefined' && typeof layersList !== 'undefined').then(ok => {
        if(!ok){
          alert('Peta atau layersList gagal dimuat.');
          return;
        }

        // --- DEFINISI LAYER & VARIABEL GLOBAL ---
        const kabSelect = document.getElementById('kabupatenSelect');
        const searchInput = document.getElementById('searchDesa');
        const resetButton = document.getElementById('btnReset');
        const popupEl = document.getElementById('popup');
        const popupCloser = document.getElementById('popup-closer');
        const popupContent = document.getElementById('popup-content');
        let hoverInteraction = null;

        const kabupatenLayers = [
          layer_Pacitan_1, layer_Ponorogo_2, layer_Trenggalek_3, layer_Tulungagung_4,
          layer_Blitar_5, layer_KotaBlitar_6, layer_Kediri_7, layer_KotaKediri_8,
          layer_Malang_9, layer_KotaMalang_10, layer_Lumajang_11, layer_Jember_12,
          layer_Banyuwangi_13, layer_Bondowoso_14, layer_Situbondo_15, layer_Probolinggo_16,
          layer_KotaProbolinggo_17, layer_Pasuruan_18, layer_KotaPasuruan_19, layer_Sidoarjo_20,
          layer_Mojokerto_21, layer_KotaMojokerto_22, layer_Jombang_23, layer_Ngajuk_24,
          layer_Madiun_25, layer_KotaMadiun_26, layer_Magetan_27, layer_Ngawi_28,
          layer_Bojonegoro_29, layer_Tuban_30, layer_Lamongan_31, layer_Gresik_32,
          layer_Bangkalan_33, layer_Sampang_34, layer_Pamekasan_35, layer_Sumenep_36,
          layer_Surabaya_37, layer_Batu_38
        ];
        const batasKabupatenLayer = layer_BatasKabupaten_39;

        // --- POPUP OVERLAY ---
        const overlay = new ol.Overlay({
          element: popupEl,
          autoPan: { animation: { duration: 250 } }
        });
        map.addOverlay(overlay);
        popupCloser.onclick = function(){
          overlay.setPosition(undefined);
          popupCloser.blur();
          return false;
        };

        // --- FUNGSI UTAMA ---

        // Style untuk highlight saat hover
        const highlightStyle = new ol.style.Style({
            stroke: new ol.style.Stroke({ color: '#ffff00', width: 3 }),
            fill: new ol.style.Fill({ color: 'rgba(255, 255, 0, 0.4)' }),
            zIndex: 99 // Penting: agar highlight selalu di atas
        });

        // Fungsi untuk mengaktifkan hover pada layer tertentu
        function enableHoverOnLayer(layerOrLayers) {
            if (hoverInteraction) map.removeInteraction(hoverInteraction);
            if (!layerOrLayers) return;

            hoverInteraction = new ol.interaction.Select({
                condition: ol.events.condition.pointerMove,
                layers: Array.isArray(layerOrLayers) ? layerOrLayers : [layerOrLayers],
                style: highlightStyle
            });
            
            hoverInteraction.on('select', e => {
                map.getTargetElement().style.cursor = e.selected.length > 0 ? 'pointer' : '';
            });

            map.addInteraction(hoverInteraction);
        }

        // Fungsi untuk mereset tampilan peta ke awal
        function resetMapView() {
            kabupatenLayers.forEach(lyr => lyr.setVisible(true));
            batasKabupatenLayer.setVisible(true);

            try {
                const combinedExtent = kabSelect.options[0].extent; // Gunakan extent yang sudah disimpan
                if(combinedExtent) map.getView().fit(combinedExtent, { padding: [40, 40, 40, 40], maxZoom: 9, duration: 700 });
            } catch (e) {
                console.warn('Gagal set extent gabungan kabupaten', e);
            }
            
            enableHoverOnLayer(kabupatenLayers);
            overlay.setPosition(undefined);
            kabSelect.value = '';
            searchInput.value = '';
        }
        
        // --- INISIALISASI PETA & KONTROL ---

        // 1. Isi dropdown dan simpan extent setiap layer
        kabSelect.innerHTML = '<option value="">-- Semua Kabupaten --</option>';
        let combinedExtent = ol.extent.createEmpty();
        kabupatenLayers.forEach((lyr, i) => {
            const title = lyr.get('title') || `Kabupaten ${i+1}`;
            const opt = document.createElement('option');
            opt.value = i;
            opt.textContent = title;
            const extent = lyr.getSource().getExtent();
            if(extent && !ol.extent.isEmpty(extent)) {
                opt.extent = extent; // Simpan extent di elemen option
                ol.extent.extend(combinedExtent, extent);
            }
            kabSelect.appendChild(opt);
        });
        // Simpan extent gabungan di option pertama
        if (!ol.extent.isEmpty(combinedExtent)) {
            kabSelect.options[0].extent = combinedExtent;
        }

        // 2. Atur tampilan awal
        resetMapView();

        // --- EVENT LISTENERS ---

        // Handle perubahan dropdown kabupaten
        kabSelect.addEventListener('change', function(){
            const selectedIndex = this.value;

            if (selectedIndex === '') {
                resetMapView();
                return;
            }

            const idx = parseInt(selectedIndex, 10);
            const selectedLayer = kabupatenLayers[idx];
            
            // Tampilkan layer yang dipilih, sembunyikan yang lain
            kabupatenLayers.forEach((lyr, i) => {
                lyr.setVisible(i === idx);
            });

            // Zoom ke kabupaten yang dipilih
            const extent = this.options[this.selectedIndex].extent;
            if (extent) {
                map.getView().fit(extent, { padding: [50, 50, 50, 50], maxZoom: 12, duration: 500 });
            }

            enableHoverOnLayer(selectedLayer);
            overlay.setPosition(undefined); // Sembunyikan popup
        });

        // Handle klik pada peta untuk menampilkan popup
        map.on('singleclick', function(evt){
            let featureFound = null;
            // Cari feature hanya pada layer yang sedang terlihat
            map.forEachFeatureAtPixel(evt.pixel, (feature, layer) => {
                if (kabupatenLayers.includes(layer) && layer.getVisible()) {
                    featureFound = feature;
                    return true; // Stop searching
                }
            });

            if (featureFound) {
                const props = featureFound.getProperties();
                // Utamakan nama desa (NAME_3/NAMA_DESA), fallback ke nama kabupaten (NAME_2)
                const name = props['NAME_3'] || props['NAMA_DESA'] || props['NAMOBJ'] || props['NAME_2'];
                const html = `<strong>Desa/Kel:</strong> ${safeText(name)}<br><strong>Kab/Kota:</strong> ${safeText(props['NAME_2'])}`;
                
                popupContent.innerHTML = html;
                overlay.setPosition(evt.coordinate);
            } else {
                overlay.setPosition(undefined);
            }
        });

        // Handle pencarian desa
        searchInput.addEventListener('keydown', function(evt){
            if (evt.key !== 'Enter') return;
            const searchText = this.value.trim().toLowerCase();
            if (!searchText) return;

            const visibleLayers = kabupatenLayers.filter(lyr => lyr.getVisible());
            if (visibleLayers.length !== 1) {
                alert('Pilih satu kabupaten/kota terlebih dahulu untuk melakukan pencarian desa.');
                return;
            }
            
            const activeLayer = visibleLayers[0];
            const source = activeLayer.getSource();
            let foundFeature = null;

            for(const feature of source.getFeatures()){
                // Sesuaikan 'NAME_3' dengan nama kolom desa/kelurahan di data Anda
                const namaDesa = (feature.get('NAME_3') || feature.get('NAMA_DESA') || feature.get('NAMOBJ') || '').toLowerCase();
                if (namaDesa.includes(searchText)) {
                    foundFeature = feature;
                    break;
                }
            }
            
            if (foundFeature) {
                const geom = foundFeature.getGeometry();
                const extent = geom.getExtent();
                map.getView().fit(extent, { padding: [100, 100, 100, 100], maxZoom: 15, duration: 700 });
                
                // Tampilkan popup untuk feature yang ditemukan
                const props = foundFeature.getProperties();
                const name = props['NAME_3'] || props['NAMA_DESA'] || props['NAMOBJ'] || props['NAME_2'];
                const html = `<strong>Desa/Kel:</strong> ${safeText(name)}<br><strong>Kab/Kota:</strong> ${safeText(props['NAME_2'])}`;

                popupContent.innerHTML = html;
                overlay.setPosition(ol.extent.getCenter(extent));
            } else {
                alert(`Desa "${this.value}" tidak ditemukan di kabupaten/kota yang dipilih.`);
            }
        });

        // Handle tombol reset
        resetButton.addEventListener('click', resetMapView);

      }); // end waitForCondition

    })();
  </script>

</body>
</html>
